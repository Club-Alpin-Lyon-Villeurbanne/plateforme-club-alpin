{#
    Composant pour s'abonner √† un calendrier ICS

    Param√®tres:
    - ics_url: URL absolue du flux ICS (https://...)
    - title: Titre du calendrier (pour l'affichage)
    - button_label: Label personnalis√© du bouton (optionnel)
#}
{% set webcal_url = ics_url|replace({'https://': 'webcal://', 'http://': 'webcal://'}) %}
{% set button_id = 'subscribe-cal-' ~ random() %}
{% set display_label = button_label|default(title ? "S'abonner √† ¬´ " ~ title ~ " ¬ª" : "S'abonner au calendrier") %}

<div class="subscribe-calendar-wrapper" style="display:inline-block;position:relative;margin:5px 0;">
    <button type="button" class="subscribe-calendar-btn" id="{{ button_id }}" title="Ajouter cet agenda √† votre calendrier personnel"
            aria-haspopup="true" aria-expanded="false" aria-controls="{{ button_id }}-menu">
        <span class="subscribe-calendar-btn-icon">üìÖ</span>
        {{ display_label }}
    </button>
    <div class="subscribe-calendar-menu" id="{{ button_id }}-menu" role="menu" aria-label="Options d'abonnement"
         style="display:none;position:absolute;left:0;top:100%;z-index:1000;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:250px;margin-top:4px;">
        <a href="https://calendar.google.com/calendar/r?cid={{ webcal_url }}" target="_blank" rel="noopener" class="subscribe-calendar-option" role="menuitem">
            <span class="subscribe-icon" aria-hidden="true">üìÖ</span> Google Calendar
        </a>
        <a href="https://outlook.live.com/calendar/0/addfromweb?url={{ webcal_url }}&name={{ title|default('Calendrier')|url_encode }}" target="_blank" rel="noopener" class="subscribe-calendar-option" role="menuitem">
            <span class="subscribe-icon" aria-hidden="true">üì¨</span> Outlook.com
        </a>
        <a href="https://outlook.office.com/calendar/0/addfromweb?url={{ webcal_url }}&name={{ title|default('Calendrier')|url_encode }}" target="_blank" rel="noopener" class="subscribe-calendar-option" role="menuitem">
            <span class="subscribe-icon" aria-hidden="true">üíº</span> Microsoft 365
        </a>
        <a href="{{ webcal_url }}" class="subscribe-calendar-option" role="menuitem">
            <span class="subscribe-icon" aria-hidden="true">üçé</span> Apple Calendar / Autre
        </a>
        <div class="subscribe-calendar-copy">
            <label for="{{ button_id }}-url">Ou copier l'URL :</label>
            <input type="text" id="{{ button_id }}-url" value="{{ ics_url }}" readonly onclick="this.select();">
        </div>
    </div>
</div>

<style>
.subscribe-calendar-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    font-size: 15px;
    font-weight: 500;
    color: #fff;
    background: linear-gradient(135deg, #4a90a4 0%, #357a8c 100%);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}
.subscribe-calendar-btn:hover {
    background: linear-gradient(135deg, #357a8c 0%, #2a6070 100%);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transform: translateY(-1px);
}
.subscribe-calendar-btn-icon {
    font-size: 18px;
}
.subscribe-calendar-option {
    display: block;
    padding: 12px 15px;
    text-decoration: none;
    color: #333;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}
.subscribe-calendar-option:hover {
    background-color: #f0f7fa;
    color: #333;
}
.subscribe-icon {
    display: inline-block;
    width: 24px;
    text-align: center;
    margin-right: 8px;
}
.subscribe-calendar-copy {
    padding: 12px 15px;
    font-size: 12px;
    color: #666;
    background: #f9f9f9;
}
.subscribe-calendar-copy input {
    width: 100%;
    margin-top: 5px;
    padding: 8px;
    font-size: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
}
</style>

<script>
(function() {
    const btn = document.getElementById('{{ button_id }}');
    const menu = document.getElementById('{{ button_id }}-menu');

    function closeAllMenus() {
        document.querySelectorAll('.subscribe-calendar-menu').forEach(m => {
            m.style.display = 'none';
            const parentBtn = document.querySelector('[aria-controls="' + m.id + '"]');
            if (parentBtn) parentBtn.setAttribute('aria-expanded', 'false');
        });
    }

    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const isVisible = menu.style.display !== 'none';
        closeAllMenus();
        if (!isVisible) {
            menu.style.display = 'block';
            btn.setAttribute('aria-expanded', 'true');
        }
    });

    document.addEventListener('click', function() {
        closeAllMenus();
    });

    menu.addEventListener('click', function(e) {
        e.stopPropagation();
    });
})();
</script>
