{% extends 'email/transactional/layout.html.twig' %}

{% block subject %}Rapport de synchronisation FFCAM du {{ date }}{% endblock %}

{% block inner_html %}
    <h2>Synchronisation des adhÃ©rents terminÃ©e</h2>

    <p>La synchronisation automatique des adhÃ©rents FFCAM s'est exÃ©cutÃ©e avec succÃ¨s.</p>

    <h3>ğŸ“Š RÃ©sumÃ© de la synchronisation</h3>

    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>Date d'exÃ©cution</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                {{ startTime|date('d/m/Y Ã  H:i:s') }}
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>DurÃ©e totale</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                {{ duration }}
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>Total traitÃ©</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                <strong style="font-size: 1.2em; color: #2da1bf;">{{ total }}</strong> adhÃ©rent(s)
            </td>
        </tr>
    </table>

    <h3>ğŸ“ˆ DÃ©tail des opÃ©rations</h3>

    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #d4f4dd;">
                <strong>âœ… Nouveaux adhÃ©rents</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.inserted }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffeaa7;">
                <strong>ğŸ”„ AdhÃ©rents mis Ã  jour</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.updated }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #dfe6e9;">
                <strong>ğŸ”— AdhÃ©rents fusionnÃ©s</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.merged }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffcccc;">
                <strong>â° AdhÃ©rents avec licence expirÃ©e</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.blocked|default(0) }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f5f3f0;">
                <strong>ğŸ‘¥ Filiations parentales supprimÃ©es</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.filiations_removed|default(0) }}</strong>
            </td>
        </tr>
        {% if stats.errors|default(0) > 0 %}
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ff6b6b; color: white;">
                <strong>âŒ Erreurs de traitement</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em; background-color: #ffe0e0;">
                <strong style="color: #d00;">{{ stats.errors }}</strong>
            </td>
        </tr>
        {% endif %}
    </table>

    {% if stats.inserted > 0 %}
    <div style="padding: 15px; background-color: #d4f4dd; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.inserted }} nouveau(x) adhÃ©rent(s)</strong> ont Ã©tÃ© ajoutÃ©s Ã  la base de donnÃ©es.
            Ces comptes sont en attente de validation et devront confirmer leur adresse email.
        </p>
    </div>
    {% endif %}

    {% if stats.merged > 0 %}
    <div style="padding: 15px; background-color: #dfe6e9; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.merged }} doublon(s) dÃ©tectÃ©(s)</strong> : des adhÃ©rents existants ont Ã©tÃ© trouvÃ©s
            avec un nouveau numÃ©ro de licence. Les comptes ont Ã©tÃ© fusionnÃ©s automatiquement.
        </p>
    </div>
    {% endif %}

    {% if stats.blocked|default(0) > 0 %}
    <div style="padding: 15px; background-color: #ffcccc; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.blocked }} adhÃ©rent(s) avec licence expirÃ©e</strong> : ces adhÃ©rents n'Ã©taient pas dans le fichier FFCAM
            et leur licence a expirÃ©. Ils ne pourront pas s'inscrire aux sorties tant qu'ils n'auront pas renouvelÃ© leur adhÃ©sion.
        </p>
    </div>
    {% endif %}

    {% if stats.filiations_removed|default(0) > 0 %}
    <div style="padding: 15px; background-color: #f5f3f0; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.filiations_removed }} filiation(s) parentale(s) supprimÃ©e(s)</strong> : les liens parent-enfant ont Ã©tÃ© supprimÃ©s
            pour les comptes non mis Ã  jour depuis plus de 200 jours.
        </p>
    </div>
    {% endif %}

    {% if stats.errors|default(0) > 0 %}
    <div style="padding: 15px; background-color: #ffe0e0; border: 2px solid #ff6b6b; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0; color: #d00;">
            <strong>âš ï¸ {{ stats.errors }} erreur(s) lors du traitement</strong> : certains adhÃ©rents n'ont pas pu Ãªtre traitÃ©s correctement.
        </p>

        {% if stats.error_details|default([]) %}
        <p style="margin: 10px 0 5px 0; color: #d00; font-weight: bold;">
            DÃ©tails des erreurs{% if stats.errors > 10 %} (10 premiÃ¨res affichÃ©es){% endif %} :
        </p>
        <ul style="margin: 5px 0; padding-left: 20px; color: #333;">
            {% for error in stats.error_details %}
            <li style="margin: 3px 0;">
                <strong>Licence {{ error.cafnum }}</strong> : {{ error.message }}
            </li>
            {% endfor %}
            {% if stats.errors > 10 %}
            <li style="margin: 5px 0; font-style: italic;">
                ... et {{ stats.errors - 10 }} autre(s) erreur(s)
            </li>
            {% endif %}
        </ul>
        <p style="margin: 10px 0 0 0; color: #666; font-size: 0.9em;">
            Ces adhÃ©rents devront Ãªtre vÃ©rifiÃ©s manuellement.
        </p>
        {% endif %}
    </div>
    {% endif %}

    <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">

    <p style="color: #666; font-size: 0.9em;">
        Ce rapport est gÃ©nÃ©rÃ© automatiquement aprÃ¨s chaque synchronisation FFCAM.
        En cas de problÃ¨me, veuillez consulter les logs dÃ©taillÃ©s dans l'interface d'administration.
    </p>
{% endblock %}