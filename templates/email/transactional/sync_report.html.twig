{% extends 'email/transactional/layout.html.twig' %}

{% block subject %}Rapport synchro (licences {% if type is same as ('annual') %}annuelles{% elseif type is same as('discovery') %}d√©couvertes{% endif %}) FFCAM du {{ date }}{% endblock %}

{% block inner_html %}
    <h2>Synchronisation des adh√©rents {% if type is same as ('annual') %}annuels{% elseif type is same as('discovery') %}d√©couvertes{% endif %} termin√©e</h2>

    <p>La synchronisation automatique des adh√©rents {% if type is same as ('annual') %}annuels{% elseif type is same as('discovery') %}d√©couvertes{% endif %} FFCAM s'est ex√©cut√©e avec succ√®s.</p>

    <h3>üìä R√©sum√© de la synchronisation</h3>

    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>Date d'ex√©cution</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                {{ startTime|date('d/m/Y √† H:i:s') }}
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>Dur√©e totale</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                {{ duration }}
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f8f8f8;">
                <strong>Total trait√©</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                <strong style="font-size: 1.2em; color: #2da1bf;">{{ total }}</strong> adh√©rents {% if type is same as ('annual') %}annuels{% elseif type is same as('discovery') %}d√©couvertes{% endif %}
            </td>
        </tr>
    </table>

    <h3>üìà D√©tail des op√©rations</h3>

    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #d4f4dd;">
                <strong>‚úÖ Nouveaux adh√©rents</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.inserted }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffeaa7;">
                <strong>üîÑ Adh√©rents mis √† jour</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.updated }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #dfe6e9;">
                <strong>üîó Adh√©rents fusionn√©s</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.merged }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffcccc;">
                <strong>‚è∞ Adh√©rents avec licence expir√©e</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.blocked|default(0) }}</strong>
            </td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #f5f3f0;">
                <strong>üë• Filiations parentales supprim√©es</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em;">
                <strong>{{ stats.filiations_removed|default(0) }}</strong>
            </td>
        </tr>
        {% if stats.errors|default(0) > 0 %}
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd; background-color: #ff6b6b; color: white;">
                <strong>‚ùå Erreurs de traitement</strong>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2em; background-color: #ffe0e0;">
                <strong style="color: #d00;">{{ stats.errors }}</strong>
            </td>
        </tr>
        {% endif %}
    </table>

    {% if stats.merged > 0 %}
    <div style="padding: 15px; background-color: #dfe6e9; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.merged }} doublon(s) d√©tect√©(s)</strong> : des adh√©rents existants ont √©t√© trouv√©s
            avec un nouveau num√©ro de licence. Les comptes ont √©t√© fusionn√©s automatiquement.
        </p>

        {% if stats.merged_details|default([]) %}
        <p style="margin: 10px 0 5px 0; font-weight: bold;">
            D√©tail des fusions{% if stats.merged > 20 %} (20 premi√®res affich√©es){% endif %} :
        </p>
        <ul style="margin: 5px 0; padding-left: 20px;">
            {% for merge in stats.merged_details %}
            <li style="margin: 3px 0;">
                <strong>{{ merge.name }}</strong> : {{ merge.old_cafnum }} est remplac√© par {{ merge.new_cafnum }}
            </li>
            {% endfor %}
            {% if stats.merged > 20 %}
            <li style="margin: 5px 0; font-style: italic;">
                ... et {{ stats.merged - 20 }} autre(s) fusion(s)
            </li>
            {% endif %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    {% if stats.blocked|default(0) > 0 %}
    <div style="padding: 15px; background-color: #ffcccc; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.blocked }} adh√©rent(s) avec licence expir√©e</strong> : leur adh√©sion n'a pas √©t√© renouvel√©e pour la saison en cours.
            Ils ne pourront pas s'inscrire aux sorties tant qu'ils n'auront pas renouvel√© leur adh√©sion.
        </p>
    </div>
    {% endif %}

    {% if stats.filiations_removed|default(0) > 0 %}
    <div style="padding: 15px; background-color: #f5f3f0; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;">
            <strong>{{ stats.filiations_removed }} filiation(s) parentale(s) supprim√©e(s)</strong> : les liens parent-enfant ont √©t√© supprim√©s
            pour les comptes non mis √† jour depuis plus de 200 jours.
        </p>
    </div>
    {% endif %}

    {% if stats.errors|default(0) > 0 %}
    <div style="padding: 15px; background-color: #ffe0e0; border: 2px solid #ff6b6b; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0; color: #d00;">
            <strong>‚ùå {{ stats.errors }} erreur(s) lors du traitement</strong> : certains adh√©rents n'ont pas pu √™tre trait√©s correctement.
        </p>

        {% if stats.error_details|default([]) %}
        <p style="margin: 10px 0 5px 0; color: #d00; font-weight: bold;">
            D√©tails des erreurs{% if stats.errors > 10 %} (10 premi√®res affich√©es){% endif %} :
        </p>
        <ul style="margin: 5px 0; padding-left: 20px; color: #333;">
            {% for error in stats.error_details %}
            <li style="margin: 3px 0;">
                <strong>{{ error.cafnum }}</strong> : {{ error.message }}
            </li>
            {% endfor %}
            {% if stats.errors > 10 %}
            <li style="margin: 5px 0; font-style: italic;">
                ... et {{ stats.errors - 10 }} autre(s) erreur(s)
            </li>
            {% endif %}
        </ul>
        <p style="margin: 10px 0 0 0; color: #666; font-size: 0.9em;">
            Ces adh√©rents devront √™tre v√©rifi√©s manuellement.
        </p>
        {% endif %}
    </div>
    {% endif %}

    {% if stats.warnings|default(0) > 0 %}
        <div style="padding: 15px; background-color: #ffeaa7; border: 2px solid orange; border-radius: 5px; margin: 20px 0;">
            <p style="margin: 0; color: orange;">
                <strong>‚ö†Ô∏è {{ stats.warnings }} warning(s) lors du traitement</strong> :
            </p>

            {% if stats.warning_details|default([]) %}
                <p style="margin: 10px 0 5px 0; color: orange; font-weight: bold;">
                    D√©tails des warnings{% if stats.warnings > 10 %} (10 premiers affich√©s){% endif %} :
                </p>
                <ul style="margin: 5px 0; padding-left: 20px; color: #333;">
                    {% for error in stats.warning_details %}
                        <li style="margin: 3px 0;">
                            {{ error }}
                        </li>
                    {% endfor %}
                    {% if stats.warnings > 10 %}
                        <li style="margin: 5px 0; font-style: italic;">
                            ... et {{ stats.warnings - 10 }} autre(s) warning(s)
                        </li>
                    {% endif %}
                </ul>
            {% endif %}
        </div>
    {% endif %}

    <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">

    <p style="color: #666; font-size: 0.9em;">
        Ce rapport est g√©n√©r√© automatiquement apr√®s chaque synchronisation FFCAM.
        En cas de probl√®me, veuillez consulter les logs d√©taill√©s dans l'interface d'administration.
    </p>
{% endblock %}