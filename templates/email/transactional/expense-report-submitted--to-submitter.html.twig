{% extends format == 'html' ? 'email/transactional/layout.html.twig' : 'email/transactional/layout.txt.twig' %}

{% block subject %}
    Votre note de frais {% if report.event %}pour "{{ report.event.titre }}"{% endif %} est envoyée
{% endblock %}

{% block inner_html %}
<div>
  {# ================== Section TRANSPORT ================== #}
  {% set transport = details.transport|default %}
  {% if transport is not empty %}
    <h2>Transport</h2>
    <ul>
      <li>
        <strong>Type :</strong>
        {% set transport_types = {
          'PERSONAL_VEHICLE': 'Véhicule personnel (taux : ' ~ tauxKilometriqueVoiture ~ ' €/km)',
          'CLUB_MINIBUS': 'Minibus du club (taux : ' ~ tauxKilometriqueMinibus ~ ' €/km)',
          'RENTAL_MINIBUS': 'Minibus de location (taux : ' ~ tauxKilometriqueMinibus ~ ' €/km)',
          'PUBLIC_TRANSPORT': 'Transport en commun'
        } %}
        {{ transport_types[transport.type]|default('Inconnu') }}
      </li>

      {% set transport_details = {
        'PERSONAL_VEHICLE': [
          {'label': 'Distance', 'value': transport.distance ~ ' km'},
          {'label': 'Péage', 'value': transport.tollFee ~ ' €'}
        ],
        'CLUB_MINIBUS': [
          {'label': 'Distance', 'value': transport.distance ~ ' km'},
          {'label': 'Péage', 'value': transport.tollFee ~ ' €'},
          {'label': 'Carburant', 'value': transport.fuelExpense ~ ' €'},
          {'label': 'Nombre de passagers', 'value': transport.passengerCount}
        ],
        'RENTAL_MINIBUS': [
          {'label': 'Péage', 'value': transport.tollFee ~ ' €'},
          {'label': 'Carburant', 'value': transport.fuelExpense ~ ' €'},
          {'label': 'Location', 'value': transport.rentalPrice ~ ' €'},
          {'label': 'Nombre de passagers', 'value': transport.passengerCount}
        ],
        'PUBLIC_TRANSPORT': [
          {'label': 'Prix du ticket', 'value': transport.ticketPrice ~ ' €'}
        ]
      } %}

      {% for detail in transport_details[transport.type]|default([]) %}
        <li><strong>{{ detail.label }} :</strong> {{ detail.value }}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Aucune dépense de transport.</p>
  {% endif %}

  <hr/>

  {# ================== Section HÉBERGEMENTS ================== #}
  {% set accommodations = details.accommodations|default %}
  {% if accommodations is not empty %}
    <h2>Hébergements</h2>
    <ul>
      {% for acc in accommodations %}
        <li>
          <strong>Hébergement {{ loop.index }} :</strong>
          {{ acc.price }} € 
          {{ acc.comment ? '- ' ~ acc.comment }}
        </li>
      {% endfor %}
    </ul>
    <p><strong>Total hébergements :</strong> {{ accommodationTotal|default }}</p>
    <p><strong>Montant remboursable (hébergements) :</strong> {{ accommodationReimbursable|default }}</p>
  {% else %}
    <p>Aucun hébergement.</p>
  {% endif %}

  <hr/>

  {# ================== Section AUTRES DÉPENSES ================== #}
  {% set others = details.others|default %}
  {% if others is not empty %}
    <h2>Autres dépenses</h2>
    <ul>
      {% for o in others %}
        <li>
          <strong>Dépense {{ loop.index }} :</strong>
          {{ o.price }} € 
          {{ o.comment ? '- ' ~ o.comment }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Aucune autre dépense.</p>
  {% endif %}

  <hr/>

  {# ================== TOTAUX GLOBAUX ================== #}
  {% if total is defined %}
    <p><strong>Total global :</strong> {{ total }}</p>
  {% endif %}
  {% if totalReimbursable is defined %}
    <p><strong>Total remboursable :</strong> {{ totalReimbursable }}</p>
  {% endif %}

  <p>
    {% if report.refundRequired %}
      Remboursement demandé.
    {% else %}
      Don au club (un reçu fiscal vous sera envoyé en fin d'année).
    {% endif %}
  </p>

  <hr/>

  {# ================== Message de fin ================== #}
  <p>
    Si vous avez fait une erreur et souhaitez modifier votre note de frais,
    merci d'en faire la demande auprès de la comptabilité :
    <a href="mailto:comptabilite@clubalpinlyon.fr">comptabilite@clubalpinlyon.fr</a>
    en indiquant le nom et la date de la sortie.
  </p>
</div>
{% endblock %}

{% block inner_txt %}
Votre note de frais {% if report.event %}pour "{{ report.event.titre }}"{% endif %} est envoyée.

Récapitulatif :
- Montant total : {{ formattedTotal }}
- Montant remboursable : {{ formattedReimbursable }}

Si vous avez fait une erreur et souhaitez modifier votre note de frais,
merci d'en faire la demande auprès de la comptabilité à l'adresse comptabilite@clubalpinlyon.fr
en indiquant le nom et la date de la sortie.
{% endblock %}
