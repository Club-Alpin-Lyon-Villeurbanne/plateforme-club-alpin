{% extends 'base.html.twig' %}

{% block title %}
    {% if article.id %}Modifier cet article{% else %}Nouvel article{% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .title-header {
            margin-top: 20px;
            margin-bottom: 15px;
            font-weight: 100;
            font-family: DIN, sans-serif;
            font-size: 1.5em;
        }
        .mini {
            font-size: 0.9em;
            color: #666;
        }
        .erreur {
            color: red;
            padding: 10px;
            background-color: #ffeeee;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .info {
            color: green;
            padding: 10px;
            background-color: #eeffee;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .alerte {
            color: #856404;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .vich-image img {
            max-width: 100%;
            height: auto;
        }
        .article-radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .article-radio-item {
            flex: 0 0 43%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 10px;
        }
        .article-radio-label.required::after {
            content: '' !important;
        }
    </style>
    <link rel="stylesheet" href="/js/ckeditor5/ckeditor5.css">
{% endblock %}

{% block body %}
    <!-- MAIN -->
    <h1 class="page-h1">{% if article.id %}<b>Modifier</b> cet article{% else %}Nouvel <b>article</b>{% endif %}</h1>

    <div style="padding:10px 0 0 30px; line-height:18px; ">
        <p class="italic">Les champs marqués d'un <span class="required">*</span> sont obligatoires.</p>

        {% if not allowed('article_create') %}
            <p class="erreur">Vous n'avez pas l'autorisation d'accéder à cette page car vous ne semblez pas avoir les droits de rédaction.</p>
        {% else %}
            {% if article.id and article.status == 1 %}
                <p class="alerte">Attention : si vous modifiez cet article, il devra à nouveau être validé par un responsable avant d'être publié sur le site !</p>
            {% endif %}

            {{ form_start(form, {'attr': {'id': 'article_form', 'action': article.id ? path('article_edit', {'id': article.id}) : path('article_new'), 'method': 'post'}}) }}
                {% if errors is defined and errors|length > 0 %}
                    <div class="erreur">
                        Erreur :
                        <ul>
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% for message in app.flashes('success') %}
                    <p class="info">
                        <img src="/img/base/tick.png" alt="" title="" />
                        {{ message }} à {{ "now"|date('H:i:s') }}.
                        <b>Important :</b> cet article doit à présent être validé par un responsable pour être publié sur le site.
                        <a href="{{ path('profile_articles') }}" title="">&gt; Retourner à la liste de mes articles</a>
                    </p>
                {% endfor %}

                <div style="margin-top: 15px">
                    {{ form_row(form.commission) }}
                    <br />

                    <div>
                        {{ form_label(form.articleType) }}
                        <div class="article-radio-group">
                            {% for child in form.articleType %}
                                <div class="article-radio-item">
                                    {{ form_widget(child, {
                                        attr: {
                                            class: 'article-radio-input'
                                        }
                                    }) }}
                                    {{ form_label(child, null, {
                                        label_attr: {
                                            class: 'article-radio-label'
                                        }
                                    }) }}

                                    {% if child.vars.value is same as ('cr') %}
                                        <div id="sortie-liee" {% if edit_mode is same as (false) %}class="hidden"{% endif %}>
                                            <br>
                                            {{ form_row(form.evt) }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            {{ form_errors(form.articleType) }}
                        </div>
                    </div>
                    <br />

                    {{ form_row(form.titre) }}
                    <br />

                    {{ form_widget(form.une) }}
                    Placer cet article à la Une ?
                    <p class="mini" style="padding-right:20px;">
                        <b>À utiliser avec parcimonie.</b> Ceci place l'article au sommet de la page d'accueil, dans les actualités défilantes.
                        Il reste affiché là jusqu'à ce qu'un autre article à la Une vienne l'en déloger. Utile pour une actualité qui dure dans le temps,
                        ou une alerte à mettre en valeur. La photo est alors obligatoire.
                    </p>
                    <br />
                </div>

                <h2 class="title-header">Photo</h2>
                <div style="width:95%">
                    Envoyez une photo horizontale pour illustrer cet article. Format .jpg, 5Mo maximum !
                    <p class="mini">
                        Une seule photo par article, chaque image envoyée remplace la précédente.
                    </p>
                    <br />

                    <div class="tw-flex tw-gap-2">
                        {% include 'components/file_upload.html.twig' with {
                            id: 'cover-image',
                            width: 'tw-w-64',
                            height: 'tw-h-32',
                            uploadUrl: '/upload-image',
                            currentImageUrl: article.mediaUpload ? vich_uploader_asset(article.mediaUpload, 'file') : null,
                            currentImageAlt: article.titre,
                            mediaIdInputId: form.mediaUploadId.vars.id,
                            maxFileSize: 5,
                            accept: 'image/*',
                            uploadText: 'Cliquer pour envoyer une photo'
                        } %}
                        <div class="tw-px-2">
                            <p>L'image est redimensionnée dans les proportions indiquées ci-contre. Prenez soin de choisir des photographies horizontales, et jamais de textes ni de logos qui seraient tronqués de façon inesthétique.</p>
                            <p>Vous pourrez ajouter toutes sortes d'images dans le corps de l'article plus bas</p>
                        </div>

                        {{ form_row(form.mediaUploadId) }}
                    </div>

                    <br style="clear:both" />
                </div>

            <div class="alerte info-container" style="width: 93%;">
                ⚠️
                <div class="text-container">
                    <div>
                        <label for="{{ form.imagesAuthorized.vars.id }}">
                            {{ form_widget(form.imagesAuthorized) }}
                            {{ form_label(form.imagesAuthorized) }}
                        </label>
                        <br><br>
                        {{ form_help(form.imagesAuthorized) }}
                    </div>
                    <br><br>
                    <div>
                        <label for="{{ form.agreeEdito.vars.id }}">
                            {{ form_widget(form.agreeEdito) }}
                            {{ form_label(form.agreeEdito) }}
                        </label>
                        <br>
                        {{ form_help(form.agreeEdito) }}
                    </div>
                </div>
            </div>

                <h2 class="title-header required">Contenu</h2>
                <div style="width:95%">
                    <div style="position:relative; right:0px; ">
                        {{ form_widget(form.cont) }}
                    </div>

                    <br />
                </div>

                <div style="width:95%">
                    <div style="text-align:center">
                        {{ form_widget(form.articleDraftSave) }}
                        {{ form_widget(form.articleSave) }}
                    </div>
                </div>
            {{ form_end(form) }}

            <br /><br />
            <br /><br />
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="/tools/tinymce/tiny_mce.js"></script>
    <script src="/js/file-upload-component.js"></script>
    <script src="/js/upload-adapter.js"></script>
    <script type="importmap">
        {
            "imports": {
                "ckeditor5": "/js/ckeditor5/ckeditor5.js",
                "ckeditor5/": "/js/ckeditor5/"
            }
        }
    </script>
    <script type="module" src="/js/ckeditor5-main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let is_update = false;
            {% if edit_mode %}
                is_update = true;
            {% endif %}

            // champ contenu pas obligatoire en js
            const contentField = document.getElementById('{{ form.cont.vars.id }}');
            if (contentField) {
                contentField.removeAttribute('required');
            }

            let sortieLiee = document.getElementById('{{ form.evt.vars.id }}');

            // sorties de la commission choisie
            document.getElementById('article_commission').addEventListener('change', function() {
                const selectedItem = document.getElementById('article_commission').selectedOptions[0];
                const commission = encodeURIComponent(selectedItem.value);

                fetch('/sorties-par-commission?commission=' + commission, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#sortie-liee').innerHTML = html;
                    sortieLiee = document.getElementById('form_evt');
                });

                // sortie liée non obligatoire si pas CR
                const radios = document.querySelectorAll('input[name="article[articleType]"]');
                radios.forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        if (this.value === 'cr') {
                            document.getElementById('sortie-liee').style.display = 'block';
                            sortieLiee.setAttribute('required', 'required');
                        } else {
                            document.getElementById('sortie-liee').style.display = 'none';
                            sortieLiee.removeAttribute('required');
                        }
                    });
                });
            });

            document.getElementById('article_form').addEventListener('submit', function (e) {
                // vérifier que le contenu est rempli
                const editorContent = document.querySelector('.ck-editor__editable').innerHTML.trim();
                const cleanedContent = editorContent.replace(/<p>/g, '').replace(/<\/p>/g, '').replace(/<br data-cke-filler="true">/g, '');
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = cleanedContent;
                const text = tempDiv.textContent.replace(/\u00A0/g, "").trim();

                if (text.length < 3) {
                    const hasMedia = tempDiv.querySelector("img, video, iframe, table, embed");
                    if (!hasMedia) {
                        alert('Veuillez renseigner le contenu de votre article.');
                        e.preventDefault();

                        return false;
                    }
                }
            });
        });
    </script>
{% endblock %}
