{% extends 'base-wide.html.twig' %}

{% block title %}Gestion des adh√©rents{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="/tools/datatables/media/css/jquery.dataTables.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
{% endblock %}

{% block body %}
    <div style="padding:20px 10px;">
        <div>
            <h1>Gestion des adh√©rents</h1>
            <p>
                <img src="/img/base/magnifier.png" style="vertical-align:middle"  alt="loupe" />
                Le champ "<i>Rechercher</i>" en haut √† droite du tableau vous permet de rechercher n'importe quelle valeur instantan√©ment.<br />
                <img src="/img/base/database_go.png" style="vertical-align:middle"  alt="go" />
                Les boutons en haut √† gauche du tableau vous permettent d'exporter le tableau courant, le plus utile √©tant l'exportation en .csv.<br />
                <img src="/img/base/info.png" style="vertical-align:middle" alt="info" />
                Vous pouvez trier les r√©sultats selon diff√©rents crit√®res en m√™me temps, en pressant la touche <i>Maj / Shift</i> et en cliquant sur les titres des colonnes.<br />
            </p>
            <br>

            <h3>Afficher les adh√©rents par statut :</h3>
            <div>
                <a href="{{ path('user_list', {'show': 'allvalid'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('allvalid') or show is same as ('valid') %}style="background:#d3d6ff"{% endif %}>
                ‚úîÔ∏è Licence valide
                </a>&nbsp;

                <a href="{{ path('user_list', {'show': 'expired'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('expired') %}style="background:#d3d6ff"{% endif %}>
                üìÖ Licence expir√©e
                </a>&nbsp;

                <a href="{{ path('user_list', {'show': 'nomade'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('nomade') %}style="background:#d3d6ff"{% endif %}>
                üåç Non-adh√©rents
                </a>&nbsp;

                <a href="{{ path('user_list', {'show': 'manual'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('manual') %}style="background:#d3d6ff"{% endif %}>
                ‚úçÔ∏è Cr√©√©s manuellement
                </a>&nbsp;

                <a href="{{ path('user_list', {'show': 'deleted'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('deleted') %}style="background:#d3d6ff"{% endif %}>
                ‚ùå Supprim√©s
                </a>&nbsp;

                <a href="{{ path('user_list', {'show': 'all'}) }}"
                   class="boutonFancy"
                   {% if show is same as ('all') %}style="background:#d3d6ff"{% endif %}>
                üìã Tous les adh√©rents
                </a>
            </div>
        </div>
        <!-- AFFICHAGE DU TABLEAU -->
        <br />
        <br />
        <br />
        {% set img_lock = '<img src="/img/base/lock_gray.png" alt="cach√©"  title="Vous devez disposer de droits sup√©rieurs pour afficher cette information" />' %}
        <table id="pagesLibres" class="datatables display">
            <thead>
            <tr>
                <th>Outils</th>
                <th>n¬∞ licence FFCAM / Infos</th>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Adh√©sion</th>
                <th>Pseudo</th>
                <th>√Çge</th>
                <th>T√©l{% if is_granted(constant('App\\Security\\SecurityConstants::ROLE_ADMIN')) %} / T√©l secours{% endif %}</th>
                <th>E-mail</th>
                <th>Compte activ√© ?</th>
                {% if is_granted(constant('App\\Security\\SecurityConstants::ROLE_ADMIN')) %}
                    <th>CP</th>
                    <th>Ville</th>
                    <th>Licence</th>
                    <th>Supprim√© ?</th>
                {% endif %}
            </tr>
            </thead>
        </table>
    </div>
    <br style="clear:both" />
    <br style="clear:both" />
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <!-- Buttons -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <!-- JSZip pour CSV/Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- (optionnel) PDFMake pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            $('#pagesLibres').dataTable({
                processing: true,
                serverSide: true,
                ajax: '{{ path('users_data', {'show': show}) }}',
                columns: [
                    { data: 'tools' },
                    { data: 'cafnum' },
                    { data: 'lastname' },
                    { data: 'firstname' },
                    { data: 'renew' },
                    { data: 'nickname' },
                    { data: 'age' },
                    { data: 'tel' },
                    { data: 'email' },
                    { data: 'active' },
                    {% if is_granted(constant('App\\Security\\SecurityConstants::ROLE_ADMIN')) %}
                        { data: 'cp' },
                        { data: 'ville' },
                        { data: 'license' },
                        { data: 'deleted' },
                    {% endif %}
                ],
                createdRow: function(row, data, dataIndex) {
                    $(row).attr('id', 'tr-' + data.id);
                    $(row).addClass(data.valid ? 'vis-on' : 'vis-off');
                },
                columnDefs: [
                    {
                        targets: 0,
                        createdCell: function(td, cellData, rowData, row, col) {
                            $(td)
                                .attr('style', 'white-space:nowrap;')
                            ;
                        }
                    }
                ],
                language: {
                    processing:     "Chargement en cours...",
                    search:         "Rechercher&nbsp;:&nbsp;",
                    lengthMenu:     "Afficher _MENU_ adh√©rents par page",
                    info:           "Affichage de _START_ √† _END_ sur _TOTAL_ adh√©rents",
                    infoEmpty:      "Affichage de 0 √† 0 sur 0 adh√©rent",
                    infoFiltered:   "(filtr√© de _MAX_ adh√©rents au total)",
                    loadingRecords: "Chargement en cours...",
                    zeroRecords:    "Aucun adh√©rent √† afficher",
                    emptyTable:     "Aucune donn√©e disponible dans le tableau",
                    paginate: {
                        first:      "Premier",
                        previous:   "Pr√©c√©dent",
                        next:       "Suivant",
                        last:       "Dernier"
                    },
                    aria: {
                        sortAscending:  ": activer pour trier la colonne par ordre croissant",
                        sortDescending: ": activer pour trier la colonne par ordre d√©croissant"
                    }
                },
                pageLength: 100,
                "iDisplayLength": 100,
                "aaSorting": [
                    [2, "asc"],
                    [3, "asc"]
                ],
                dom: 'Bfrtip', // active la barre ded boutons
                buttons: [
                    {
                        extend: 'csvHtml5',
                        text: 'Exporter en CSV',
                        className: 'btn btn-outline-primary',
                        fieldSeparator: ';', // pour CSV fran√ßais
                        bom: true, // encodage UTF-8 correct pour accents
                        title: 'Liste_des_utilisateurs'
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'Exporter en Excel',
                        className: 'btn btn-outline-success',
                        title: 'Liste_des_utilisateurs'
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'Exporter en PDF',
                        className: 'btn btn-outline-danger',
                        title: 'Liste_des_utilisateurs',
                        orientation: 'landscape', // ou 'portrait'
                        pageSize: 'A4',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13] // colonnes √† exporter
                        },
                        customize: function(doc) {
                            doc.styles.tableHeader.fillColor = '#50b7e4'; // header bleu
                            doc.styles.tableHeader.color = 'white';
                            doc.styles.tableHeader.alignment = 'center';
                        }
                    },
                    {
                        extend: 'print',
                        text: 'Imprimer',
                        className: 'btn btn-outline-secondary'
                    }
                ]
            });
            $('span.br').html('<br />');
        });
    </script>
{% endblock %}
