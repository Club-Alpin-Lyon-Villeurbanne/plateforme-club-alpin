{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
    <div id="form-event">
        <h1 class="page-h1">{{ title }}</h1>

        {% import 'macros/form_macros.html.twig' as form_macros %}
        {% form_theme form with ['form/encadrants_checkbox_theme.html.twig', 'form/field_error.html.twig'] %}

        {{ form_start(form, {
            attr: {class: 'padded-form', 'id': 'event_form'}
        }) }}

        <p class="italic">
            Les champs marqués d'un <span class="required">*</span> sont obligatoires.
            <br>Les champs marqués d'un <span class="revalidation">*</span> demanderont une réapprobation de la sortie par un responsable de commission si vous les modifiez.
        </p>

        {% if form.vars.errors|length > 0 %}
            <br>
            <div class="alerte has-errors">
                Le formulaire contient des erreurs, merci de vérifier votre saisie.<br><br>
                <ul>
                    {% for error in form.vars.errors %}
                        <li>{{ error.message }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        <br class="clear">

        <div style="float:left; padding:0 20px 10px 0">
            {% if is_update %}
                Sortie liée à la commission :<br />
                <b>{{ commission }}</b>
            {% else %}
                {{ form_row(form.commission) }}
            {% endif %}
        </div>
        <div style="float:right;margin-right:20px;">
            {{ form_row(form.titre) }}
        </div>
        <br style="clear:both" /><br>

        <div id="individus">
            {{ form_macros.display_encadrement(form, is_update) }}
        </div>

        <h2 class="clear trigger-h2">Informations :</h2>
        <div class="trigger-me">
            <div style="float:left; width:45%; padding:0 20px 5px 0;">
                {{ form_row(form.rdv) }}
                {{ form_row(form.lat) }}
                {{ form_row(form.long) }}
            </div>

            <div style="float:left; width:45%; padding:0 20px 0 0;">
                <label>Précisez sur la carte <span class="required">*</span></label>
                <button name="codeAddress" class="biglink btn-marker" style="border-radius:5px; cursor:pointer;"><span class="bleucaf">&gt;</span> PLACER LE MARQUEUR</button><br>
                <div class="mini help-text">
                    Cliquez ci-dessus pour placer le marqueur sur la carte, puis déplacez ce dernier sur le <span style="text-decoration: underline;">lieu exact du RDV</span>. Vous pouvez zoomer / dézoomer.
                </div>
            </div>
            <br style="clear:both" />

            <div id="place_finder_error" class="erreur" style="display:none"></div>
            <div id="map-creersortie"></div>
            <br style="clear:both" />

            <div style="width:45%; padding-right:3%; float:left">
                {{ form_row(form.eventStartDate) }}
            </div>
            <div style="width:50%; float:left">
                {{ form_row(form.eventEndDate) }}
            </div>
            <br style="clear:both" />

            {{ form_row(form.place) }}
            <ul id="place_suggestions"></ul>
        </div>

        <h2 class="trigger-h2">Tarif :</h2>
        <div class="trigger-me">
            <div>
                {{ form_label(form.tarif) }}
                {{ form_errors(form.tarif) }}
                {{ form_widget(form.tarif) }} €<br />
                {{ form_help(form.tarif) }}
            </div><br />
            {{ form_row(form.tarifDetail) }}
        </div>

        <h2 class="trigger-h2">Inscriptions :</h2>
        <div class="trigger-me">
            <div style="width:45%; padding-right:3%; float:left">
                <div>
                    {{ form_label(form.ngensMax) }}
                    {{ form_errors(form.ngensMax) }}
                    {{ form_widget(form.ngensMax) }} {{ form_help(form.ngensMax) }}
                </div><br />
            </div>
            <div style="width:50%; float:left">
                {{ form_row(form.joinMax) }}
            </div>
            <br style="clear:both" />
            {{ form_row(form.joinStartDate) }}
            <br style="clear:both" /><br>
            <div>
                <label for="{{ form.autoAccept.vars.id }}" class="{% if form.autoAccept.vars.data %}up{% else %}down{% endif %}">
                    {{ form_widget(form.autoAccept) }}
                    {{ field_label(form.autoAccept) }}
                </label>
                {{ form_help(form.autoAccept) }}
            </div>
        </div>

        <h2 class="trigger-h2">Difficulté / matériel :</h2>
        <div class="trigger-me">
            {{ form_row(form.difficulte) }}<br />
            <div>
                {{ form_label(form.denivele) }}
                {{ form_errors(form.denivele) }}
                {{ form_widget(form.denivele) }} m
            </div><br />
            <div>
                {{ form_label(form.distance) }}
                {{ form_errors(form.distance) }}
                {{ form_widget(form.distance) }} km
            </div><br />
            <div style="float:right; padding-right:20px;">
                {{ form_widget(form.stuff_list) }} <input type="button" value="appliquer" class="nice" id="predefinitions-matos-submit" />
            </div>
            {{ form_row(form.matos) }}
        </div>

        <h2 class="trigger-h2">Itinéraire de l'activité :</h2>
        <div class="trigger-me">
            {{ form_row(form.itineraire) }}
        </div>

        <h2 class="trigger-h2">Détails pratiques (partie invisible aux adhérents non connectés) :</h2>
        <div class="trigger-me">
            {{ form_row(form.details_caches) }}
        </div>

        <br>
        <div class="alerte info-container" style="width: 93%;">
            ⚠️
            <div class="text-container">
                <div>
                    <label for="{{ form.imagesAuthorized.vars.id }}">
                        {{ form_widget(form.imagesAuthorized) }}
                        {{ form_label(form.imagesAuthorized) }}
                    </label>
                    <br><br>
                    {{ form_help(form.imagesAuthorized) }}
                </div>
                <br><br>
                <div>
                    <label for="{{ form.agreeEdito.vars.id }}">
                        {{ form_widget(form.agreeEdito) }}
                        {{ form_label(form.agreeEdito) }}
                    </label>
                    <br>
                    {{ form_help(form.agreeEdito) }}
                </div>
            </div>
        </div>

        <h2 class="trigger-h2">Description complète <span class="required">*</span> :</h2>
        <div class="trigger-me">
            <p>
                Entrez ci-dessous toutes les informations qui ne figurent pas dans le formulaire.<br>
                N'hésitez pas à mettre un maximum de détails, cet élément formera le corps de la page dédiée à cette sortie.
            </p>
            {{ form_row(form.description) }}
        </div>

        <br /><br />
        <div style="text-align:center">
            {{ form_widget(form.eventDraftSave) }}
            {{ form_widget(form.eventSave) }}
        </div>

        <div class="hidden">
            {{ form_end(form) }}
        </div>

        <br class="clear" /><br /><br /><br />
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin="" />
    <link rel="stylesheet" href="/js/ckeditor5/ckeditor5.css">
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ vite_entry_script_tags('participants') }}
    {{ vite_entry_script_tags('commission_switch') }}
    {{ vite_entry_script_tags('autocomplete_communes') }}
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script type="text/javascript" src="/js/map.js"></script>
    <script type="importmap">
        {
            "imports": {
                "ckeditor5": "/js/ckeditor5/ckeditor5.js",
                "ckeditor5/": "/js/ckeditor5/"
            }
        }
    </script>
    <script type="module" src="/js/ckeditor5-main.js"></script>
    <script type="text/javascript">
        // au chargement complet de la page
        document.addEventListener('DOMContentLoaded', function () {
            {% if is_update is same as (true) %}
                initParticipantsCheckboxes(document);
            {% else %}
                switchCommission(document);
            {% endif %}
            searchCommunes(document);

            // liste matériel
            document.querySelector('#predefinitions-matos-submit').addEventListener('click', (e) => {
                const textarea = document.querySelector('#event_matos');
                const select = document.querySelector('#event_stuff_list');
                let replaceContent = true;

                if (textarea.value !== '') {
                    replaceContent = confirm('Ceci va effacer le contenu actuel du champ "Matériel nécessaire". Continuer ?');
                }
                if (replaceContent) {
                    textarea.value = select.value.replace(/\*/g, "\n");
                }
            });

            // refresh au changement de commission
            document.querySelector('#event_commission').addEventListener('change', (e) => {
                // groupe et participants selon la commission choisie
                switchCommission(document);
            });

            // champ description pas obligatoire en js
            const contentField = document.getElementById('{{ form.description.vars.id }}');
            if (contentField) {
                contentField.removeAttribute('required');
            }
        });

        document.getElementById('event_form').addEventListener('submit', function (e) {
            let prefix = 'form';
            {% if is_update %}
                prefix = 'event';
            {% endif %}

            // vérifier qu'au moins 1 encadrant ou stagiaire est coché
            const encadrants = document.querySelectorAll('input[name="' + prefix + '[encadrants][]"]:checked');
            const initiateurs = document.querySelectorAll('input[name="' + prefix + '[initiateurs][]"]:checked');
            const encadrement = encadrants.length + initiateurs.length;
            if (encadrement <= 0) {
                alert('Veuillez sélectionner au moins un encadrant ou initiateur stagiaire.');
                e.preventDefault();

                return false;
            }

            // vérifier que la description est remplie
            const editorContent = document.querySelector('.ck-editor__editable > p').innerHTML.trim();
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = editorContent;
            const text = tempDiv.textContent.replace(/\u00A0/g, "").trim();

            if (text.length <= 3) {
                const hasMedia = tempDiv.querySelector("img, video, iframe, table, embed");
                if (!hasMedia) {
                    alert('Veuillez renseigner une description pour cette sortie.');
                    e.preventDefault();

                    return false;
                }
            }
        });
    </script>
{% endblock %}
