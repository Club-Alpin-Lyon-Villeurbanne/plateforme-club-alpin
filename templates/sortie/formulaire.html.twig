{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
    <div id="form-event">
        <h1 class="page-h1">{{ title }}</h1>

        {% import 'macros/form_macros.html.twig' as form_macros %}
        {% form_theme form 'form/encadrants_checkbox_theme.html.twig' %}
        {% form_theme form 'form/ckeditor_theme.html.twig' %}

        {{ form_start(form, {
            attr: {class: 'padded-form'}
        }) }}

        {% if isUpdate and event.status is same as (1) %}
            <p class="alerte">Attention : si vous modifiez cette sortie, elle devra à nouveau être validée par un responsable avant d'être affichée sur le site !</p><br />
        {% endif %}

        <div style="width:45%; padding-right:3%; float:left">
            {% if isUpdate %}
                Sortie liée à la commission :<br />
                <b>{{ commission }}</b>
            {% else %}
                {{ form_row(form.commission) }}
            {% endif %}
        </div>
        <div style="width:50%; float:left" id="groupe">
            {{ form_macros.display_group_form_field(form.groupe) }}
        </div>
        <br style="clear:both" />

        <div id="individus">
            {{ form_macros.display_encadrement(form, isUpdate) }}
        </div>

        <h2 class="clear trigger-h2">Informations :</h2>
        <div class="trigger-me">
            {{ form_row(form.titre) }}<br />
            {{ form_row(form.massif) }}<br />

            <div style="float:left; width:45%; padding:0 20px 5px 0;">
                {{ form_row(form.rdv) }}
                {{ form_row(form.lat) }}
                {{ form_row(form.long) }}
            </div>

            <div style="float:left; width:45%; padding:0 20px 0 0;">
                Précisez sur la carte :<br />
                <input type="button" name="codeAddress" class="type2" style="border-radius:5px; cursor:pointer;" value="Placer le marqueur sur la carte" />
                <div class="mini">
                    Cliquez ci-dessus pour placer le marqueur sur la carte, puis déplacez ce dernier sur le <span style="text-decoration: underline;">lieu exact du RDV</span>. Vous pouvez zoomer / dézoomer.
                </div>
            </div>
            <br style="clear:both" />

            <div id="place_finder_error" class="erreur" style="display:none"></div>
            <div id="map-creersortie"></div>
            <br style="clear:both" />

            <div style="width:45%; padding-right:3%; float:left">
                {{ form_row(form.eventStartDate) }}
            </div>
            <div style="width:50%; float:left">
                {{ form_row(form.eventEndDate) }}
            </div>
            <br style="clear:both" />
        </div>

        <h2 class="trigger-h2">Inscriptions :</h2>
        <div class="trigger-me">
            <div style="width:45%; padding-right:3%; float:left">
                <div>
                    {{ form_label(form.ngensMax) }}
                    {{ form_widget(form.ngensMax) }} {{ form_help(form.ngensMax) }}
                </div><br />
            </div>
            <div style="width:50%; float:left">
                {{ form_row(form.joinMax) }}
            </div>
            <br style="clear:both" /><br />
            {{ form_row(form.joinStartDate) }}
        </div>

        <h2 class="trigger-h2">Description complète <span class="required">*</span> :</h2>
        <div class="trigger-me">
            {{ form_row(form.description) }}
        </div>

        <h2 class="trigger-h2">Tarif :</h2>
        <div class="trigger-me">
            <div>
                {{ form_label(form.tarif) }}
                {{ form_widget(form.tarif) }} €<br />
                {{ form_help(form.tarif) }}
            </div><br />
            {{ form_row(form.tarifDetail) }}
        </div>

        <h2 class="trigger-h2">Difficulté / matériel :</h2>
        <div class="trigger-me">
            {{ form_row(form.difficulte) }}<br />
            <div>
                {{ form_label(form.denivele) }}
                {{ form_widget(form.denivele) }} m
            </div><br />
            <div>
                {{ form_label(form.distance) }}
                {{ form_widget(form.distance) }} km
            </div><br />
            <div style="float:right; padding-right:20px;">
                {{ form_widget(form.stuff_list) }} <input type="button" value="appliquer" class="nice" id="predefinitions-matos-submit" />
            </div>
            {{ form_row(form.matos) }}
        </div>

        <h2 class="trigger-h2">Itinéraire :</h2>
        <div class="trigger-me">
            {{ form_row(form.itineraire) }}
        </div>

        <h2 class="trigger-h2">Détails pratiques (partie invisible aux adhérents non connectés) :</h2>
        <div class="trigger-me">
            {{ form_row(form.details_caches) }}
        </div>
        <br /><br />

        <div style="text-align:center">
            {{ form_widget(form.eventSave) }}
        </div>

        <div class="hidden">
            {{ form_end(form) }}
        </div>

        <br class="clear" /><br /><br /><br />
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin="" />
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ vite_entry_script_tags('participants') }}
    {{ vite_entry_script_tags('commission_switch') }}
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script type="text/javascript" src="/js/map.js"></script>
    {{ vite_entry_script_tags('ckeditor') }}
    <script type="text/javascript">
        // au chargement complet de la page
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('form[name="event"]').addEventListener('submit', function (e) {
                document.querySelectorAll('textarea.ckeditor').forEach((el) => {
                    if (el._ckeditorInstance) {
                        el.value = el._ckeditorInstance.getData().trim();

                        // vérifier que la description complète est renseignée
                        if ('event_description' === el.id && '' === el._ckeditorInstance.getData().trim()) {
                            e.preventDefault();
                            alert('La description complète est obligatoire.');
                            return false;
                        }
                    }
                });
            });

            // liste matériel
            document.querySelector('#predefinitions-matos-submit').addEventListener('click', (e) => {
                const textarea = document.querySelector('#event_matos');
                const select = document.querySelector('#event_stuff_list');
                let replaceContent = true;

                if (textarea.value !== '') {
                    replaceContent = confirm('Ceci va effacer le contenu actuel du champ "Matériel nécessaire". Continuer ?');
                }
                if (replaceContent) {
                    textarea.value = select.value.replace(/\*/g, "\n");
                }
            });

            // refresh au changement de commisssion
            document.querySelector('#event_commission').addEventListener('change', (e) => {
                // groupe et participants selon la commission choisie
                switchCommission(document);
            });
        });
    </script>
{% endblock %}
