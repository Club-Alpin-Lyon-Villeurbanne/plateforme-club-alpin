{% extends 'base.html.twig' %}

{% block title %}{{ event.titre }}{% endblock %}

{% macro user_inscription_button(event, filiations, my_status) %}

    {% if event.joinMax > 0 %}
        {% set style = '' %}
        {% if my_status and not my_status.isCovoiturage %}
            {% set style = 'border:1px solid red; background:rgba(255,153,153,.4);' %}
        {% endif %}
        <div style="text-align:center; padding:0 30px 0 0">
            <br />
            <a class="biglink" href="javascript:void(0)" onclick="$('#inscription').slideToggle(200)" title="" style="{{ style }}">
            <span class="bleucaf">&gt;</span>
            {% if not my_status %}
            JE SOUHAITE REJOINDRE CETTE SORTIE
            {% else %}
            JE METS A JOUR MES PREFERENCES {% if style %}<img src="/img/base/bullet_error.png" title="Mettre √† jour les pr√©f√©rences" width="16px">&nbsp;{% endif %}
            {% endif %}

            {% if filiations|length > 0 %}
                <span class="bleucaf">&nbsp; / &nbsp;</span> INSCRIRE DES ADH√âRENTS AFFILI√âS
            {% endif %}
            </a>
        </div>
    {% else %}
        <hr /><div class="alerte">Pas d'inscription par internet</div>
    {% endif %}
{% endmacro %}

{% block body %}
    {% import 'macros/cancel_block.html.twig' as block_macros %}
        <div id="fiche-sortie">

            {% set closeDiv = false %}

            {% if event.publicStatusUnseen %}
                {% set closeDiv = true %}

                <div class="alerte">
                    <b>Note : Cette sortie n'est pas publi√©e sur le site</b>.
                    Si vous voyez ce message appara√Ætre, c'est que vous disposez de droits particuliers
                    qui vous autorisent √† voir cette page.
                    Les usagers r√©guliers du site n'ont pas acc√®s aux informations ci-dessous.<br />

                {% if is_granted('SORTIE_VALIDATE', event) %}
                    <div>
                        <form action="{{ path('sortie_validate', { id: event.id }) }}" method="post" class="loading" style="display:inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_validate') }}" />
                            <input type="submit" value="Autoriser &amp; publier" class="nice2 green" title="Autorise instantan√©ment la publication de la sortie" />
                        </form>
                        <input type="button" value="Refuser" class="nice2 red" onclick="modal.show($(this).next().html())" title="Ne pas autoriser la publication de cette sortie. Vous devrez ajouter un message au cr√©ateur de la sortie." />
                        <div style="display:none" id="refuser-{{ event.id }}">
                            <form action="{{ path('sortie_refus', { id: event.id }) }}" method="post" class="loading">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_refus') }}" />
                                <p>Laissez un message √† l'auteur pour lui expliquer la raison du refus :</p>
                                <input type="text" name="msg" class="type1" placeholder="ex: Mauvais point de RDV" />
                                <input type="submit" value="Refuser la publication" class="nice2 red" />
                                <input type="button" value="Annuler" class="nice2" onclick="$.fancybox.close()" />
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% elseif event.publicStatusRefuse %}
                {% set closeDiv = true %}
                <div class="alerte">
                    <b>Note : Cette sortie a √©t√© refus√©e</b>.
                    Si vous voyez ce message appara√Ætre, c'est que vous disposez de droits particuliers
                    qui vous autorisent √† voir cette page. Les usagers r√©guliers du site n'ont pas acc√®s
                    aux informations ci-dessous.<br /><br />
            {% elseif event.cancelled %}
                {% set closeDiv = true %}
                <div class="erreur">
                    <img src="/img/base/cross.png" alt="" title="" style="float:left; padding:2px 6px 0 0;" />
                    <b>Sortie annul√©e :</b><br /> Cette sortie a √©t√© annul√©e le {{ event.cancelledWhen | date('d/m/Y √† H:i') }}

                {% if event.cancelledWho %}
                    , par <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ event.cancelledWho.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">{{ event.cancelledWho.nickname }}</a>
                {% endif %}
                <br />

                {% if is_granted('SORTIE_UNCANCEL', event) %}
                    <form action="{{ path('sortie_uncancel', { id: event.id }) }}" method="post" class="loading">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_uncancel') }}" />
                        <input type="submit" value="R√©activer cette sortie" class="nice2 red" title="R√©activer cette sortie" />
                    </form>
                {% endif %}

            {% elseif event.publicStatusValide and (is_granted('SORTIE_UPDATE', event) or is_granted('SORTIE_DELETE', event) or is_granted('SORTIE_CANCEL', event)) %}
                {% set closeDiv = true %}

                <div class="alerte">
                    <b>Note :</b> Cette sortie est publi√©e et visible par les adh√©rents !<br />
            {% endif %}

                {% if is_granted('SORTIE_UPDATE', event) %}
                    <a href="{{ path('modifier_sortie', {'event': event.id}) }}" title="Vous √™tes l'auteur de cette sortie ? Cliquez ici pour la modifier." class="nice2 noprint orange">
                        <img src="/img/base/pencil.png" alt="" title="" style="" />&nbsp;&nbsp;Modifier cette sortie
                    </a>
                {% endif %}

                {% if is_granted('SORTIE_DELETE', event) %}
                    <a class="nice2 noprint red" href="/supprimer-une-sortie/{{ event.code }}-{{ event.id }}.html" title="Supprimer d√©finitivement la sortie ci-dessous">
                        <img src="/img/base/x2.png" alt="" title="" style="" />&nbsp;&nbsp;Supprimer cette sortie
                    </a>
                {% endif %}

                {% if is_granted('SORTIE_CANCEL', event) %}
                    <a class="nice2 noprint red" href="/annuler-une-sortie/{{ event.code }}-{{ event.id }}.html" title="Annuler la sortie ci-dessous">
                        <img src="/img/base/delete.png" alt="" title="" style="" />&nbsp;&nbsp;Annuler cette sortie
                    </a>
                {% endif %}

            {% if closeDiv %}
                </div><br />
            {% endif %}
        {% for article in event.articles %}
        <a style="float:right; font-family:DIN, Arial; font-weight:normal; display:block; padding:5px 20px 0 0;" href="/article/{{ article.code }}-{{ article.id }}.html" title="{{ article.titre }}">
            <span class="bleucaf">></span> Voir le compte rendu de sortie "{{ article.titre }}"
        </a>
        {% endfor %}

        <h1>
            <span class="commission">{{ event.commission.title }}</span>
            <span class="bleucaf">></span> {{ event.titre }}
            {% if event.groupe %}
                <small> ({{ event.groupe.nom }}) </small>
            {% endif %}
            <span class="date"> / {{ event.tsp | intldate('cccc d MMMM yyyy') }}</span>
        </h1>

        <div class="tw-flex tw-gap-4">
            {% if is_granted('SORTIE_DUPLICATE', event) %}
            <form action="{{ path('sortie_duplicate', { id: event.id, mode: 'full' }) }}" method="post" class="loading">
                <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_duplicate') }}" />

                <a href="javascript:void(0)" onclick="$(this).parents('form').submit()" title="Cr√©er une sortie avec les m√™mes participants et les m√™mes param√®tres" class="nice2">
                    <img src="/img/base/add.png" alt="Dupliquer la sortie avec ce groupe" title="" style="height:20px" />
                    Dupliquer cette sortie avec ce groupe
                </a>
            </form>
                <form action="{{ path('sortie_duplicate', { id: event.id, mode: 'empty' }) }}" method="post" class="loading">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_duplicate') }}" />

                    <a href="javascript:void(0)" onclick="$(this).parents('form').submit()" title="Cr√©er une sortie avec les m√™mes param√®tres (sans participant)" class="nice2">
                        <img src="/img/base/add.png" alt="Dupliquer la sortie" title="" style="height:20px" />
                        Dupliquer cette sortie
                    </a>
                </form>
            {% endif %}
        </div>

        {% if app.user and event.user.id == app.user.id and event.isFinished %}
            <a href="/article/new?compterendu=true&amp;commission_article=-1&amp;evt_article={{ event.id }}" title="Vous √™tes l'auteur de cette sortie ? R√©digez un compte rendu" class="nice2 noprint">
                <img src="/img/base/pencil_add.png" alt="" title="" style="" />
                Compte rendu
            </a><br>
        {% endif %}

        {% if is_granted('FICHE_SORTIE', event) %}
        <a href="/feuille-de-sortie/evt-{{ event.id }}.html" title="Ouvrir une nouvelle page avec la fiche compl√®te des participants" class="nice2" target="_blank">
            <img src="/img/base/print.png" alt="PRINT" title="" style="height:20px" />
            Imprimer la fiche de sortie
        </a>
        <a href="{{ path('sortie_pdf', { id: event.id }) }}" title="Imprimer la fiche de sortie en PDF" class="nice2" target="_blank">
            <img src="/img/base/pdf.png" alt="PRINT" title="" style="height:20px" />
            Imprimer la fiche de sortie en PDF
        </a>
        <a class="nice2" href="{{ path('sortie_xlsx', { id: event.id }) }}" title="Exporter la liste des participants en Excel">
            <img src="/img/base/sheet.png" alt="" title="" /> Exporter la liste des participants en Excel
        </a>
        {% endif %}

        {% set my_status = event.participation(app.user) %}

        {% if not event.isFinished %}
            {% if allowed('user_read_limited') %}
                <input id="add-to-calendar" type="button" class="nice2" value="üìÖ Ajouter √† mon agenda" />

                <script>
                const config = {
                    name: "{{ event.titre }}",
                    startDate: "{{ event.tsp | intldate('yyyy-MM-dd') }}",
                    startTime: "{{ event.tsp | date('H:i') }}",
                    endDate: "{{ event.tspEnd | intldate('yyyy-MM-dd') }}",
                    endTime: "{{ event.tspEnd | date('H:i') }}",
                    location: "{{ event.rdv }}",
                    options: ['Apple','Google','iCal','Outlook.com','Yahoo','Microsoft365'],
                    timeZone: "Europe/Paris",
                    language: "fr"
                };
                const button = document.getElementById('add-to-calendar');
                if (button) {
                    button.addEventListener('click', () => atcb_action(config, button));
                }
                </script>
            {% else %}
                Vous n'avez pas acc√®s √† certaines informations de cette sortie car vous n'√™tes pas connect√©.
            {% endif %}
        {% endif %}
 
        <br />
        <br />


        {% if my_status and my_status.status == constant('App\\Entity\\EventParticipation::STATUS_NON_CONFIRME') %}
            {% if not event.finished %}
                {% if allowed('evt_unjoin') %}
                    <div class="alerte info-container" style="margin-right:2rem !important">
                        <img src="/img/inscrit-standby.png" alt="" title=""/>
                        <div class="text-container">
                            Vous avez demand√© √† participer √† cette sortie, et votre demande est en attente de validation.<br />
                            <div class="button-container">
                                <input type="button" class="nice" value="Annuler ma demande" onclick="$('#inscription-annuler').slideToggle(200)" style="margin-top:6px;" />
                            </div>
                        </div>
                    </div>
                    {% include 'components/cancel-participation.html.twig' with {'my_status_id': my_status.id} %}
                {% endif %}
            {% else %}
                <div class="alerte info-container" style="margin-right:2rem !important">
                    <img src="/img/inscrit-standby.png" alt="" title=""/>
                    <div class="text-container">
                        Vous avez demand√© √† participer √† cette sortie, mais votre demande est rest√©e en attente.<br />
                    </div>
                </div>
                <br />
            {% endif %}
        {% endif %}

        {% if my_status and my_status.status == constant('App\\Entity\\EventParticipation::STATUS_REFUSE') %}
            <div class="erreur info-container" style="margin-right:2rem !important">
                <img src="/img/inscrit-cross.png" alt="" title=""/>
                <div class="text-container">
                    Vous avez demand√© √† participer √† cette sortie, mais l'organisateur a d√©clin√© votre inscription.
                    N'h√©sitez pas √† le contacter pour en savoir plus.
                </div>
            </div>
            <br />
        {% endif %}

        {% if my_status and my_status.status == constant('App\\Entity\\EventParticipation::STATUS_VALIDE') %}
            {% if my_status.role == 'encadrant' or my_status.role == 'stagiaire' or my_status.role == 'coencadrant' or my_status.role == 'benevole' %}
                {% if not event.finished %}
                    {% if allowed('evt_unjoin') %}
                        {{ block_macros.display_confirmed_cancel_block(my_status.role) }}
                        {% include 'components/cancel-participation.html.twig' with {'my_status_id': my_status.id} %}
                    {% endif %}
                {% else %}
                    <div class="info info-container" style="margin-right:2rem !important">
                        <img src="/img/inscrit-encadrant.png" alt="" title=""/>
                        <div class="text-container">
                            Vous avez particip√© √† cette sortie en tant que : {{ my_status.role }}.
                        </div>
                    </div>
                    <br />
                {% endif %}

                {# expense report form #}

                {% if display_notes_de_frais %}
                    {% if event.finished and not event.cancelled and (my_status.role == 'encadrant' or my_status.role == 'coencadrant' or my_status.role == 'stagiaire') %}
                        {% if event.statusLegal %}
                            {% include 'vuejs/expense-report-form.twig' %}
                        {% else %}
                            <div class="alerte info-container" style="margin-right:2rem !important; margin-bottom:2rem !important">
                                <img src="/img/base/cross.png" alt="" title=""/>
                                <div class="text-container">
                                    <b>Note de frais non disponible :</b><br />
                                    Cette sortie n'a pas √©t√© valid√©e par le pr√©sident. Il n'est donc pas possible de soumettre de note de frais.<br />
                                    Si vous pensez qu'il s'agit d'une erreur, contactez votre responsable de commission.<br />&nbsp;
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% else %}
                {% if not event.finished %}
                    {% if allowed('evt_unjoin') %}
                        {{ block_macros.display_confirmed_cancel_block('participant') }}
                        {% include 'components/cancel-participation.html.twig' with {'my_status_id': my_status.id} %}
                    {% endif %}
                {% else %}
                    <div class="info info-container" style="margin-right:2rem !important">
                        <img src="/img/inscrit-check.png" alt="" title=""/>
                        <div class="text-container">
                            Vous avez particip√© √† cette sortie.
                        </div>
                    </div>
                    <br />
                {% endif %}
            {% endif %}
        {% endif %}

        {% if is_granted('SORTIE_INSCRIPTIONS_MODIFICATION', event) %}
            <link rel="stylesheet" href="/tools/datatables/media/css/jquery.dataTables.sobre.css" type="text/css" media="screen" />
            <script type="text/javascript" src="/tools/datatables/media/js/jquery.dataTables.min.js"></script>
            <script type="text/javascript">

                // jquery
                $(document).ready(function(){

                    var expr = new RegExp('>[ \t\r\n\v\f]*<', 'g');
                    var tbhtml = $('.datatable').html();
                    $('.datatable').html(tbhtml.replace(expr, '><'));

                    // datatables
                    $('.datatable').dataTable( {
                        "aaSorting": [],
                        "iDisplayLength" : -1,
                        "bLengthChange": false,
                        "bFilter": false,
                        "bPaginate": false,
                        "bInfo": false
                        // "aLengthMenu": [[-1],  ["All"]]
                        // "bLengthChange": false
                        // "sDom": 'T<"clear">lfrtip'
                    } );

                    // format de couleur du changement de statut
                    $('.joinlabels input').bind('change', function(){
                        // changment ligne
                        $(this).parents('tr').removeClass('status0 status1 status2 status3 status-1').addClass('status'+$(this).val());

                        // changement des stats
                        var nAcceptees=0;
                        var nRefusees=0;
                        $('.joinlabels input:checked[type=radio]').each(function(){
                            if($(this).val()==1) 	nAcceptees++;
                            if($(this).val()==2) 	nRefusees++;

                        });
                        $('#nAcceptees').html(nAcceptees);
                        $('#nRefusees').html(nRefusees);
                    });

                });
            </script>

            <div id="inscription-gestion">
                {% if not event.finished %}
                    {{ easy_include('formalites-gestion-des-inscrits', 'vide') }}
                {% else %}
                    {{ easy_include('formalites-gestion-des-inscrits-evt-passe', 'vide') }}
                {% endif %}

                <br />
                <select id="contact_participants_type" class="type1" style="display:none; min-width: 250px;">
                    <option value="">S√©lectionner des destinataires</option>
                    <option value="all">Tout le monde</option>
                    <option value="accepted">Les participants accept√©s</option>
                    <option value="refused">Les participants refus√©s</option>
                    <option value="waiting">Les participants en attente</option>
                    <option value="absent">Les absents</option>
                </select>
                <br /><br />

                <form id="contact_update_participants" method="post" class="loading">
                    <input type="hidden" name="csrf_token_inscriptions" value="{{ csrf_token('sortie_update_inscriptions') }}" />
                    <input type="hidden" name="csrf_token_contact" value="{{ csrf_token('contact_participants') }}" />

                    <table class="datatable">
                        <thead>
                            <tr>
                                <th class="select-contact"></th>
                                <th width='30%'>Nom / Pseudo</th>
                                <th width='15%'>Statut</th>
                                <th width='15%'>R√¥le</th>
                                <th width='10%'>Date</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participation in participations %}
                                {% set participation = participation['liste'] %}
                                {% set class = '' %}
                                {% if participation.isStatusEnAttente %}
                                    {% set class = 'waiting' %}
                                {% elseif participation.isStatusValide %}
                                    {% set class = 'accepted' %}
                                {% elseif participation.isStatusRefuse %}
                                    {% set class = 'refused' %}
                                {% elseif participation.isStatusAbsent %}
                                    {% set class = 'absent' %}
                                {% endif %}

                                <tr class="status{{ participation.status }}" style="color:gray; font-size:10px;">
                                    <td class="select-contact">
                                        <input type="checkbox" id="contact_participant_{{ participation.id }}" name="contact_participant[{{ participation.id }}]" value="{{ participation.id }}" class="contact-cb {{ class }}" />
                                    </td>

                                    <td>
                                        {{ participation.user.firstname | capitalize }} {{ participation.user.lastname | upper }}<br/>
                                        <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ participation.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">{{ participation.user.nickname }}</a>

                                        {% if age_user(participation.user) and age_user(participation.user) < 18 %}
                                            <p style="color:red">{{ age_user(participation.user) }} ans</p>
                                        {% endif %}
                                        {% if participation.user.doitRenouveler %}
                                            <p style="color:red">&#9888;&#65039; Licence expir√©e</p>
                                        {% endif %}
                                    </td>

                                    <td class="mini joinlabels status{{ participation.status }}">

                                    {% set disable_waiting = true %}
                                    {% set disable_accepted = true %}
                                    {% set disable_refused = true %}
                                    {% set disable_absent = true %}
                                    {% set disable_unsubscribe = true %}

                                    {% if app.user is same as (event.user) or allowed('evt_joining_accept', 'commission:' ~ event.commission.code) or allowed('evt_join_doall') %}
                                        {% set disable_waiting = false %}
                                        {% set disable_accepted = false %}
                                        {% set disable_absent = false %}
                                    {% endif %}
                                    {% if app.user is same as (event.user) or allowed('evt_joining_refuse', 'commission:' ~ event.commission.code) or allowed('evt_join_doall') %}
                                        {% set disable_refused = false %}
                                    {% endif %}
                                    {% if app.user is same as (event.user) or allowed('evt_unjoin_notme', 'commission:' ~ event.commission.code) or allowed('evt_join_doall') %}
                                        {% set disable_unsubscribe = false %}
                                    {% endif %}

                                    {% if empietements[participation.user.id] is defined %}
                                        <div class="empietements">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Attention au timing :</b>
                                            {% for empietement in empietements[participation.user.id] %}
                                                {% if empietement.status == constant('App\\Entity\\EventParticipation::STATUS_NON_CONFIRME') %}
                                                    <br />- Adh√©rent pr√©-inscrit sur
                                                    <br /><a href="{{ path('sortie', { code : empietement.event.code, id: empietement.event.id }) }}">{{ empietement.event.titre }}</a>
                                                {% elseif empietement.status == constant('App\\Entity\\EventParticipation::STATUS_VALIDE') %}
                                                    <br />- Adh√©rent <span style="color:red">confirm√©</span> sur <br />
                                                    <br /><a href="{{ path('sortie', { code : empietement.event.code, id: empietement.event.id }) }}">{{ empietement.event.titre }}</a>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    {% if participation.role != 'encadrant' %}
                                        <span style="display:none">{{ participation.status }}</span>
                                        <input type="hidden" name="id_evt_join[]" value="{{ participation.id }}" />

                                        {% if participation.isStatusEnAttente %}
                                            <label for="join_{{ participation.id }}_0">
                                                <input
                                                    checked="checked"
                                                    {{ disable_waiting ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    name="status_evt_join_{{ participation.id }}"
                                                    id="join_{{ participation.id }}_0"
                                                    value="0"
                                                />
                                                En attente
                                            </label>
                                        {% endif %}

                                        {% if event.finished and participation.isStatusValide %}
                                            <label for="join_{{ participation.id }}_1">
                                                <input
                                                    {{ participation.isStatusValide ? 'checked="checked"' : '' }}
                                                    {{ disable_accepted ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    name="status_evt_join_{{ participation.id }}"
                                                    id="join_{{ participation.id }}_1"
                                                    value="1"
                                                />
                                                Pr√©sent
                                            </label>
                                        {% elseif not event.finished %}
                                            <label for="join_{{ participation.id }}_1">
                                                <input
                                                    {{ participation.isStatusValide ? 'checked="checked"' : '' }}
                                                    {{ disable_accepted ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    name="status_evt_join_{{ participation.id }}"
                                                    id="join_{{ participation.id }}_1"
                                                    value="1"
                                                />
                                                Accept√©
                                            </label>
                                        {% endif %}

                                        {% if event.finished and not participation.isStatusRefuse and not participation.isStatusEnAttente %}
                                            <label for="join_{{ participation.id }}_3">
                                                <input
                                                    {{ participation.isStatusAbsent ? 'checked="checked"' : '' }}
                                                    {{ disable_absent ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    name="status_evt_join_{{ participation.id }}"
                                                    id="join_{{ participation.id }}_3"
                                                    value="3"
                                                />
                                                Absent
                                            </label>
                                        {% endif %}

                                        {% if (event.finished and participation.isStatusRefuse) or not event.finished %}
                                            <label for="join_{{ participation.id }}_2">
                                                <input
                                                    {{ participation.isStatusRefuse ? 'checked="checked"' : '' }}
                                                    {{ disable_refused ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    name="status_evt_join_{{ participation.id }}"
                                                    id="join_{{ participation.id }}_2"
                                                    value="2"
                                                />
                                                Refus√©
                                            </label>
                                        {% endif %}

                                        {% if (event.finished and not participation.isStatusRefuse and not participation.isStatusEnAttente) or not event.finished %}
                                            <label for="join_{{ participation.id }}_-1">
                                                <input
                                                    name="status_evt_join_{{ participation.id }}"
                                                    {{ disable_unsubscribe ? 'disabled="disabled"' : '' }}
                                                    type="radio"
                                                    id="join_{{ participation.id }}_-1"
                                                    value="-1"
                                                />
                                                D√©sinscrire
                                            </label>
                                        {% endif %}


                                    {% endif %}

                                    </td>
                                    <td class="mini" >
                                        {% if participation.user.nomade %}
                                            <br />
                                            {% if not participation.user.email %}
                                                <img
                                                    src="/img/base/bullet_error.png"
                                                    alt="!"
                                                    title="Attention. Ne re√ßoit pas d'e-mail"
                                                    style="vertical-align:top"
                                                />
                                            {% endif %}
                                            <br />
                                        {% elseif participation.isRoleManuel or participation.isRoleInscrit or participation.isRoleBenevole %}
                                            {% if participation.isRoleManuel %}
                                                <label style="display:block; white-space:nowrap;" for="role_join_{{ participation.id }}_m">
                                                    <input
                                                        checked="checked"
                                                        name="role_evt_join_{{ participation.id }}"
                                                        type="radio"
                                                        id="role_join_{{ participation.id }}_m"
                                                        value="manuel"
                                                    />
                                                    Manuel
                                                </label>
                                            {% endif %}
                                            <label style="display:block; white-space:nowrap;" for="role_join_{{ participation.id }}_i">
                                                <input
                                                    {% if participation.isRoleInscrit %}checked="checked"{% endif%}
                                                    name="role_evt_join_{{ participation.id }}"
                                                    type="radio"
                                                    id="role_join_{{ participation.id }}_i"
                                                    value="inscrit"
                                                />
                                                Inscrit
                                            </label>
                                            <label style="display:block; white-space:nowrap;" for="role_join_{{ participation.id }}_b">
                                                <input
                                                    {% if participation.isRoleBenevole %}checked="checked"{% endif%}
                                                    name="role_evt_join_{{ participation.id }}"
                                                    type="radio"
                                                    id="role_join_{{ participation.id }}_b"
                                                    value="benevole"
                                                />
                                                B√©n√©vole
                                            </label>
                                        {% else %}
                                            {{ participation | participation_role_name }}<br />
                                        {% endif %}
                                        {% if participation.user is same as event.user %}
                                            (organisateur)
                                        {% endif %}

                                    </td>
                                    <td style="white-space:nowrap">
                                        <span style="display:none">{{ participation.tsp }}</span>
                                        {{ participation.tsp | date('d/m') }}<br />
                                        {{ participation.tsp | date('√† H:i') }}
                                    </td>
                                    <td>
                                        {% if participation.user.valid %}
                                            <a href="mailto:{{ participation.user.email }}">{{ participation.user.email | u.truncate(15, '...') }}</a><br />
                                        {% else %}
                                            <span style="color: red; font-weight: bold" title="Les comptes non activ√©s ne re√ßoivent pas les e-mails">compte non activ√©</span><br />
                                        {% endif %}
                                        {{ participation.user.tel }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- stats affich√©es -->
                    <p>Stats :</p>
                    {% set nbDemandesAcceptees = (event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_VALIDE')) | length) + (event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_ABSENT')) | length) %}
                    <ul>
                        <li>
                            <b id="nDemandes">{{ event.participations(null, null) | length }}</b> demande(s), dont
                            <b id="nAcceptees">{{ nbDemandesAcceptees }}</b> accept√©e(s) et
                            <b id="nRefusees">{{ event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_REFUSE')) | length }}</b> refus√©e(s)
                        </li>
                        {% if (event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_NON_CONFIRME')) | length > 0) %}
                            <li>
                                <b id="nAttente">{{ event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_NON_CONFIRME')) | length }}</b> rest√©(s) en attente
                            </li>
                        {% endif %}
                        <li>
                            <b id="nAbsents">{{ event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_ABSENT')) | length }}</b> absent(s)
                        </li>
                    </ul>

                    <br style="clear:both"  />

                    {% if is_granted('SORTIE_INSCRIPTIONS_MODIFICATION', event) %}
                        <p class="mini">
                            <input type="checkbox" name="disablemails" />
                            Ne pas envoyer les e-mails lors de la mise √† jour (d√©conseill√©, sauf apr√®s l'√©v√©nement).
                        </p>

                        <div style="text-align:center">
                            <br />
                            <button id="submit_update_participants" type="submit" style="cursor: pointer; border: none;" class="biglink" title="Enregistrer" formaction="{{ path('sortie_update_inscription', { id: event.id })}}">
                                <span class="bleucaf">&gt;</span>
                                ENREGISTRER LES STATUTS CI-DESSUS
                            </button>
                        </div>
                    {% elseif event.participation(app.user) %}
                        <p class="mini">{{ event.participation(app.user) | participation_status_name }} : Vous ne pouvez pas modifier les inscriptions</p>
                    {% endif %}
                    <br />
                    <br />
                <hr />

                {% if is_granted('SORTIE_INSCRIPTIONS_MODIFICATION', event) %}
                    <h2 id="autresoptions">Autres options :</h2>

                    {% if is_granted('SORTIE_CONTACT_PARTICIPANTS', event) %}
                    <!-- Contact par email des participants (orga uniquement) -->
                    <a class="nice2 blue" href="javascript:void(0)" onclick="$('#contact-inscrits').slideToggle();$('.select-contact').toggle();$('#contact_participants_type').toggle();">
                        <img src="/img/base/email.png" alt="" title="" /> Envoyer un e-mail group√© aux inscrits
                    </a>
                    <br />

                    <div id="contact-inscrits" style="display: none; border : 1px solid #eaeaea; box-shadow:0 0 20px -10px gray;; padding:10px; margin:10px 0 20px 0;; border-radius:10px">
                        <h2>Formulaire de contact</h2>

                        <div>
                            <br>
                            S√©lectionnez les destinataires dans le tableau ci-dessus, en cochant les cases correspondantes en d√©but de ligne.
                        </div>

                        <br />
                        <label for="objet">Objet :</label><br />
                        <input id="contact_subject" type="text" name="objet" class="type1" style="width:95%" value="Note importante pour la sortie du {{ event.tsp | date('d/m') }}" /><br />
                        <br />

                        <label>R√©pondre √† ?</label><br />
                        <input type="radio" name="reply_to_option" id="reply_to_option_me_only" value="me_only" />
                        <label for="reply_to_option_me_only"> Uniquement moi</label><br />

                        <input type="radio" name="reply_to_option" id="reply_to_option_everyone" value="everyone" />
                        <label for="reply_to_option_everyone"> Tous les encadrants et co-encadrants d√©clar√©s</label><br />
                        <br />

                        <label for="message">Message :</label><br />
                        <textarea id="contact_message" name="message" class="type1" style="width:95%; height:150px"></textarea>

                        <br /><br />
                        <input id="submit_contact_participants" type="submit" class="nice" value="&gt; Envoyer mon message" onclick="$.fancybox.close()" formaction="{{ path('contact_participants', { id: event.id }) }}" />
                    </div>
                    {% endif %}

                    {% if allowed('user_see_all') or allowed('evt_join_notme') or allowed('evt_join_doall') %}
                        {% if not event.publicStatusUnseen %}
                            <a class="nice2 blue fancyframe" href="/includer.php?p=includes/join_manual.php&amp;id_evt={{ event.id }}" title="">
                                Inscrire manuellement des adh√©rents du club
                            </a>

                            <a class="nice2 blue fancyframe" href="/includer.php?p=includes/join_nomad.php&amp;id_evt={{ event.id }}" title="">
                                Ajouter un adh√©rent "Nomade"
                            </a>
                        {% else %}
                        <i>Vous pourrez ajouter des participants quand la sortie sera publi√©e</i>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </form>
            <br style="clear:both"  /><br />

        </div>
        <br />
        <hr />
        {% endif %}

        {% if event.massif or event.place or event.itineraire %}
            <ul class="nice-list">
                {% if event.massif %}
                    <li class="wide"><b>MASSIF :</b> {{ event.massif }}</li>
                {% endif %}
                {% if event.place %}
                    <li class="wide"><b>LIEU D√âPART ACTIVIT√â :</b> {{ event.place }}</li>
                {% endif %}
                {% if event.itineraire %}
                    <li class="wide"><b>ITIN√âRAIRE DE L'ACTIVIT√â :</b> {{ event.itineraire }}</li>
                {% endif %}
            </ul>
            <br style="clear:both" />
            <hr />
        {% endif %}

        {% if event.denivele or event.distance or event.difficulte or event.matos %}
            <ul class="nice-list">
                {% if event.denivele %}
                    <li class="wide"><b>D√âNIVEL√â :</b> {{ event.denivele }} m</li>
                {% endif %}
                {% if event.distance %}
                    <li class="wide"><b>DISTANCE :</b> {{ event.distance }} km</li>
                {% endif %}
                {% if event.difficulte %}
                    <li class="wide"><b>DIFFICULT√â :</b> {{ event.difficulte }}</li>
                {% endif %}
                {% if event.matos %}
                    <li class="wide"><b>MAT√âRIEL :</b> {{ event.matos | converturls | nl2br }}</li>
                {% endif %}
            </ul>
            <br style="clear:both" />
            <hr />
        {% endif %}

        {# Bloc d√©tails cach√©s #}
        {% if event.detailsCaches %}
            <ul class="nice-list">
                <li class="wide"><b>D√âTAILS PRATIQUES :</b><br />
                    {% if allowed('user_read_limited') %}
                        {{ event.detailsCaches | converturls | nl2br }}
                    {% else %}
                        D√©tails de la sortie visibles apr√®s connexion
                    {% endif %}
                </li>
            </ul>
            <br style="clear:both" />
            <hr />
        {% endif %}

        {% if not event.cancelled %}
            <ul class="nice-list">
                <li class="wide"><b>DESCRIPTION COMPL√àTE :</b></li>
            </ul>
            <div class="description_evt">{{ event.description | raw }}</div>
            <hr style="clear:both" />

            {% if (event.tarif > 0 or event.tarifDetail) %}
                <ul class="nice-list">
                    {% if allowed('user_read_limited') %}
                        {% if event.tarif %}
                            <li class="wide"><b>TARIF :</b> {{ event.tarif }} Euros</li>
                        {% endif %}
                        {% if event.tarifDetail %}
                            <li class="wide"><b>D√âTAILS DES FRAIS :</b><br /> {{ event.tarifDetail | converturls | nl2br }}</li>
                        {% endif %}
                    {% else %}
                        {% if event.tarif %}
                            <li class="wide"><b>TARIF :</b> visible apr√®s connexion</li>
                        {% endif %}
                        {% if event.tarifDetail %}
                            <li class="wide"><b>D√âTAILS DES FRAIS :</b> visible apr√®s connexion</li>
                        {% endif %}
                    {% endif %}
                </ul>
                <br style="clear:both" />
                <hr />
            {% endif %}

            <ul class="nice-list">
                <li>
                    <b>D√âPART :</b> Le {{ event.tsp | intldate('cccc d MMMM') }} {% if allowed('user_read_limited') %}{{ event.tsp|date('H:i') }}{% endif %}
                </li>
                <li>
                    <b>RETOUR :</b> Le {{ event.tspEnd | intldate('cccc d MMMM') }} {% if allowed('user_read_limited') %}{{ event.tspEnd|date('H:i') }}{% endif %}
                </li>
            </ul>

            {% if allowed('user_read_limited') %}
                <ul class="nice-list">
                    <li><b>RDV :</b> {% if event.rdv is not same as ('') %}{{ event.rdv }}{% else %}Voir sur la carte ci-dessous{% endif %}</li>
                    <li class="wide"><b>POINT DE RENDEZ-VOUS SUR LA CARTE :</b> </li>
                </ul>
                <br style="clear:both" />
                <div id="map-fichesortie"></div>
                <script>
                    $(function() {
                        var zoom = 16;
                        var lat = {{ event.lat|replace({',':'.'}) }};
                        var lon = {{ event.long|replace({',':'.'}) }};
                        var mymap = L.map('map-fichesortie').setView([lat, lon], zoom);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?{foo}', {foo: 'bar', attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}).addTo(mymap);
                        var marker = L.marker([lat, lon]).addTo(mymap);
                    })
                </script>
            {% else %}
                <ul class="nice-list">
                    <li><b>RDV :</b> lieu et heures visibles apr√®s connexion</li>
                </ul>
            {% endif %}
            <hr />
        {% endif %}

        <ul class="nice-list">
            <li class="wide">
                <b>SORTIE D√âPOS√âE PAR :</b>
                <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ event.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">
                    {{ event.user.nickname }}
                </a>
                <span class="mini">
                - le {{ event.tspCrea | date('d/m/y') }}{% if event.tspEdit %}, modifi√©e le {{ event.tspEdit | date('d/m/y √† H:i') }} {% endif %}
            </span>
            </li>

            {% if event.encadrants('encadrant') | length > 0 %}
                <li class="wide"><b>ENCADRANTS :</b>
                    {% for encadrant in event.encadrants('encadrant') %}
                        {% if loop.index > 1 %}, {% endif %}
                        <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ encadrant.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">
                            {{ encadrant.user.nickname }}
                        </a>
                    {% endfor %}
                </li>
                <br style="clear:both" />
            {% endif %}

            {% if event.encadrants('stagiaire') | length > 0 %}
                <li class="wide"><b>STAGIAIRE :</b>
                    {% for stagiaire in event.encadrants('stagiaire') %}
                        {% if loop.index > 1 %}, {% endif %}
                        <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ stagiaire.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">
                            {{ stagiaire.user.nickname }}
                        </a>
                    {% endfor %}
                </li>
                <br style="clear:both" />
            {% endif %}

            {% if event.encadrants('coencadrant') | length > 0 %}
                <li class="wide"><b>CO-ENCADRANTS :</b>
                    {% for encadrant in event.encadrants('coencadrant') %}
                        {% if loop.index > 1 %}, {% endif %}
                        <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ encadrant.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">
                            {{ encadrant.user.nickname }}
                        </a>
                    {% endfor %}
                </li>
                <br style="clear:both" />
            {% endif %}

            {% if event.encadrants('benevole') | length > 0 %}
                <li class="wide"><b>B√âN√âVOLES :</b>
                    {% for encadrant in event.encadrants('benevole') %}
                        {% if loop.index > 1 %}, {% endif %}
                        <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ encadrant.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">
                            {{ encadrant.user.nickname }}
                        </a>
                    {% endfor %}
                </li>
                <br style="clear:both" />
            {% endif %}

            <br style="clear:both" />

            {% if event.needBenevoles and not event.cancelled %}
                {{ easy_include('alerte-benevoles', 'alerte-benevoles') }}
            {% endif %}

        </ul>
        <br style="clear:both" />
        {% if not event.hasStarted and event | is_legal_validable  %}
            {{ easy_include('status-legal-' ~ event.statusLegal, 'status-legal') }}
            <br />

            {% if is_granted('SORTIE_LEGAL_VALIDATION', event) %}
                <div class="status-legal noprint">
                    <h2>Validation de la sortie :</h2>
                    <p>
                        Pour valider cette sortie en tant que sortie officielle du CAF,
                        ou refuser d'associer cette sortie au {{ sitename }},
                        cliquez sur un des boutons ci-dessous.
                    </p>
                    <p>
                        <b>Attention !</b> Cette op√©ration est d√©finitive !
                    </p>

                    <form action="{{ path('sortie_legal_refus', { id: event.id }) }}" method="post" class="loading" style="display:inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_legal_refus') }}" />
                        <input type="submit" class="nice2 red" value="Refuser la validation" />
                    </form>
                    <form action="{{ path('sortie_legal_validate', { id: event.id }) }}" method="post" class="loading" style="display:inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token('sortie_legal_validate') }}" />
                        <input type="submit" class="nice2 green" value="Valider" />
                    </form>

                    <br />&nbsp;
                </div>
                <br />
            {% endif %}
        {% endif %}

        {% if not event.cancelled %}
            {% set nInscritsHorsEncadrement = event.participations([constant('App\\Entity\\EventParticipation::ROLE_INSCRIT'), constant('App\\Entity\\EventParticipation::ROLE_BENEVOLE'), constant('App\\Entity\\EventParticipation::ROLE_MANUEL')]) | length %}
            {% set nInscritsTotal = nInscritsHorsEncadrement + event.participations([constant('App\\Entity\\EventParticipation::ROLE_COENCADRANT'), constant('App\\Entity\\EventParticipation::ROLE_STAGIAIRE'), constant('App\\Entity\\EventParticipation::ROLE_ENCADRANT')]) | length %}
            {% set nPlacesRestantesOnline = max(0, event.joinMax - event.participations([constant('App\\Entity\\EventParticipation::ROLE_INSCRIT'), constant('App\\Entity\\EventParticipation::ROLE_BENEVOLE')]) | length) %}
            {% set nEnAttente = event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_NON_CONFIRME')) | length %}

            {% if nPlacesRestantesOnline > event.ngensMax - nInscritsTotal %}
                {% set nPlacesRestantesOnline = max(0, event.ngensMax - nInscritsTotal) %}
            {% endif %}

            <hr />
            <ul class="nice-list">
                <li><b>NOMBRE TOTAL DE PLACES :</b> {{ event.ngensMax }}
                <li><b>DISPONIBLES VIA INTERNET :</b> {{ nPlacesRestantesOnline }}
            </ul>

            <br style="clear:both" /><hr />

            <p>
                <span title="{{ event | temoin_event_title }}" style="padding: 10px 10px 5px 5px;float:left;">
                    <span class="temoin-places-dispos"> {{ event | temoin_event_picto }}</span>
                </span>
                <span style="font-size:14px; font-family:DINBold; color:#666666">
                    {{ nInscritsTotal }} PARTICIPANT{{ nInscritsTotal > 1 ? 'S' : '' }} INSCRIT{{ nInscritsTotal > 1 ? 'S' : '' }}
                    SUR  {{ event.ngensMax }} PLACE{{ event.ngensMax ? 'S' : '' }} AU TOTAL
                    ({{ event.ngensMax > 0 ? (100 * nInscritsTotal / event.ngensMax) | round : 0 }}%)
                </span><br />
                {{ nPlacesRestantesOnline }} place{{ nPlacesRestantesOnline > 1 ? 's' : '' }} restante{{ nPlacesRestantesOnline > 1 ? 's' : '' }}
                pour les inscriptions en ligne
                {{ nEnAttente > 0 ? ' et '~nEnAttente~' inscription'~ (nEnAttente > 1 ? 's' : '' ) ~' en attente de confirmation' : '' }}
            </p>

            {% if app.user and nInscritsTotal > 0 and not is_granted('MODIFICATION_SORTIE', event) %}
                <table class="big-lines-table" style="width:570px; margin-left:20px;">

                    {% for inscrit in event.participations(null, constant('App\\Entity\\EventParticipation::STATUS_VALIDE')) | sort((a, b) => a.user.firstname <=> b.user.firstname) %}
                        <td>
                        <td>
                            {% if allowed('user_read_private', event.commission.code) %}
                                <p class="mini">{{ inscrit.user.lastname|upper }}, {{ inscrit.user.firstname|capitalize }}</p>
                            {% endif %}
                            <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ inscrit.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">{{ inscrit.user.nickname }}</a>
                        </td>
                        <td class="small">
                            {% if allowed('user_read_private', event.commission.code) %}
                                {{ inscrit.user.tel }}
                            {% endif %}
                        <td class="small">
                            {% if allowed('user_read_private', event.commission.code) %}
                                {{ inscrit.user.tel2 }}
                            {% endif %}
                        </td>
                        <td class="small">
                            {% if allowed('user_read_private', event.commission.code) %}
                                {{ inscrit.user.email }}
                            {% endif %}
                        </td>
                        <td class="small">
                            {% if allowed('user_read_limited', event.commission.code) and inscrit.isCovoiturage %}
                                <img src="/img/voiture.png" title="Covoiturage" width="16px">
                            {% endif %}
                        </td>
                        </tr>
                    {% endfor %}

                    {% for inscrit in event.participations(null, constant('App\\Entity\\EventParticipation::ROLE_MANUEL')) %}

                        <tr>
                            <td>
                                {% if allowed('user_read_private', event.commission.code) %}
                                    <p class="mini">{{ inscrit.user.lastname|upper }}, {{ inscrit.user.firstname|capitalize }}</p>
                                    <a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ inscrit.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">{{ inscrit.user.nickname }}</a>
                                {% else %}
                                    {{ inscrit.user.nickname }}
                                {% endif %}
                            </td>
                            <td class="small">
                                {% if allowed('user_read_private', event.commission.code) %}
                                    {{ inscrit.user.tel }}
                                {% endif %}
                            <td class="small">
                                {% if allowed('user_read_private', event.commission.code) %}
                                    {{ inscrit.user.tel2 }}
                                {% endif %}
                            </td>
                            <td class="small">
                                {% if allowed('user_read_private', event.commission.code) %}
                                    {{ inscrit.user.email }}
                                {% endif %}
                            </td>
                            <td class="small">
                                {% if allowed('user_read_limited', event.commission.code) and inscrit.isCovoiturage %}
                                    <img src="/img/voiture.png" title="Covoiturage" width="16px">
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}

                </table>
            {% endif %}

            {# si utilisateur est inscrit, il a acc√®s #}
            {% if nPlacesRestantesOnline > 0 or event.participation(app.user) %}

                {% if allowed('evt_join') %}

                    {% if not app.user.doitRenouveler %}
                        {% if not event.hasStarted %}
                            {% if event.joinHasStarted %}
                                {% if is_granted('JOIN_SORTIE', event) %}
                                    {{ _self.user_inscription_button(event, filiations, my_status) }}

                                    <div id="inscription" style="display:none">

                                    {{ easy_include('formalites-inscription', 'formalites') }}

                                    <form id="join_sortie" action="{{ app.request.requestUri }}#inscription" method="post" class="loading">

                                        <input type="hidden" name="operation" value="user_join" />
                                        <input type="hidden" name="id_evt" value="{{ event.id }}" />

                                        <div class="check-nice ">
                                            <p>
                                                <label style="width:100%;clear:both;overflow:hidden;">
                                                    <input id="confirm_conditions" type="checkbox" name="confirm" /> J'ai lu les conditions d'usage ci-dessus et confirme ma demande d'inscription.
                                                </label>
                                            </p>
                                            <hr class="clear">

                                            {% if event.needBenevoles and not my_status %}
                                                <p>
                                                    <label style="width:100%;clear:both;overflow:hidden;">
                                                        <input type="checkbox" name="jeveuxetrebenevole" /> Cochez cette case si vous souhaitez rejoindre la sortie en tant que <b>b√©n√©vole</b>.
                                                    </label>
                                                </p>
                                            {% endif %}

                                            {% if filiations | length %}
                                                <hr class="clear" />
                                                {{ easy_include('inscrire-filiation-select') }}

                                                <input type="hidden" name="filiations" value="on" />
                                                <br />
                                                <label for="filiation_id_user_{{ app.user.id }}" style="width:100%;clear:both;overflow:hidden;">
                                                    <input
                                                        type="checkbox"
                                                        checked="checked"
                                                        class="custom"
                                                        name="id_user_filiation[]"
                                                        value="{{ app.user.id }}"
                                                        id="filiation_id_user_{{ app.user.id }}" />
                                                    Moi-m√™me (<a href="/includer.php?p=includes/fiche-profil.php&amp;id_user={{ app.user.id }}&amp;id_event={{ event.id }}" class="fancyframe userlink">{{ app.user.nickname }}</a>)
                                                </label>
                                                <br />
                                                {% for filiation in filiations %}
                                                    <br />
                                                    <label for="filiation_id_user_{{ filiation.id }}" style="width:100%;clear:both;overflow:hidden;">
                                                        <input
                                                            type="checkbox"
                                                            onclick="$('#paiement_enfant_{{ filiation.id }}').slideToggle(200)"
                                                            class="custom"
                                                            name="id_user_filiation[]"
                                                            value="{{ filiation.id }}"
                                                            id="filiation_id_user_{{ filiation.id }}" />
                                                        {{ filiation.lastname }}, {{ filiation.firstname }} ({{ filiation.id }}, {{ filiation.nickname }})
                                                    </label>
                                                {% endfor %}
                                                <hr class="clear" />
                                            {% endif %}
                                        </div>

                                        <p style="text-align:center">
                                            <label for="name">Ajouter un message √† votre demande (optionnel) :</label><br>
                                            <textarea name="message" placeholder="Par exemple :
- J'ai tel niveau et telle exp√©rience
- J'ai une voiture avec 4 places dispos
- Je n'ai pas de crampons, ce n'est pas mentionn√©, est-ce critique ?" class="type1" style="width:50%; height:100px"></textarea>
                                        </p>

                                        <p style="text-align:center">
                                            <a class="biglink" href="javascript:void(0)" title="Enregistrer" onclick="$(this).parents('form').submit()">
                                                <span class="bleucaf">&gt;</span>
                                                {% if not my_status %}
                                                    ENVOYER MA DEMANDE D'INSCRIPTION
                                                {% else %}
                                                    METTRE A JOUR MES PREFERENCES
                                                {% endif %}
                                            </a>
                                        </p>
                                    </form>
                                    <script>
                                        $(function () {
                                            $('#join_sortie').on('submit', function (event) {
                                                event.preventDefault();
                                                var $this = $(this);

                                                if ($('#confirm_conditions').prop('checked')) {
                                                    $(this).unbind('submit').submit();
                                                } else {
                                                    alert('Vous devez accepter les conditions d\'usage pour vous inscrire.');
                                                    return false;
                                                }
                                            })
                                        })
                                    </script>

                                </div>
                                {% endif %}
                            {% else %}
                                <hr />
                                <h2>Inscriptions :</h2>
                                <p>Les inscriptions pour cette sortie commenceront le {{ event.joinStart | date('d/m/y') }}</p>
                            {% endif %}
                        {% else %}
                            {{ easy_include('info-inscription-passee', 'vide') }}
                        {% endif %}
                    {% else %}
                        {{ easy_include('info-inscription-licence-obsolete', 'vide') }}
                    {% endif %}
                {% else %}
                    {{ easy_include('info-inscription-non-connecte', 'vide') }}
                {% endif %}

            {% else %}
                <p>Le nombre de places disponibles √† la r√©servation depuis internet est atteint.</p>
            {% endif %}
        {% endif %}
    </div>
    <br style="clear:both" />
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" type="text/css"  media="screen" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // champs obligatoires selon le form valid√©
            const btn1 = document.getElementById('submit_update_participants');
            const btn2 = document.getElementById('submit_contact_participants');

            const contact_subject = document.getElementById('contact_subject');
            const contact_message = document.getElementById('contact_message');
            const contact_reply_to = document.querySelector('input[name="reply_to_option"]');

            btn1.addEventListener('click', () => {
                contact_subject.required = false;
                contact_message.required = false;
                contact_reply_to.required = false;
            });

            btn2.addEventListener('click', () => {
                contact_subject.required = true;
                contact_message.required = true;
                contact_reply_to.required = true;
            });

            // s√©lection automatique de certains participants
            const checkboxes = document.querySelectorAll('.contact-cb');
            const select = document.getElementById('contact_participants_type');

            select.addEventListener('change', () => {
                // reset la s√©lection actuelle
                checkboxes.forEach(checkbox => checkbox.checked = false);

                // appliquer la s√©lection choisie
                const selectedOption = select.options[select.selectedIndex].value;
                if (undefined !== selectedOption && selectedOption !== '') {
                    const selectedCheckboxes = document.querySelectorAll('.' + selectedOption);
                    selectedCheckboxes.forEach(checkbox => checkbox.checked = true);
                    if ('all' === selectedOption) {
                        checkboxes.forEach(checkbox => checkbox.checked = true);
                    }
                }
            });
        });
    </script>
{% endblock %}

{% block og_markup %}
    <meta property="og:title" content="{{ event.titre }}" />
    <meta property="og:description" content="{{ event.description|striptags|slice(0, 200) ~ '...' }}" />
{% endblock %}
