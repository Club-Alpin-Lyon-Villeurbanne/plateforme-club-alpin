name: Code Quality
on: [pull_request]

jobs:
  php-cs:
    name: PHP CS Fixer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir l'historique git complet

      - name: Prepare environment
        uses: ./.github/actions/prepare-for-quality

      - name: Cache PHP-CS-Fixer
        uses: actions/cache@v4
        with:
          path: .php-cs-fixer.cache
          key: ${{ runner.os }}-php-cs-fixer-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-php-cs-fixer-
            ${{ runner.os }}-

      # Pour les PR : analyse seulement les fichiers modifiés
      - name: Get changed PHP files
        id: changed-php-files
        run: ./.github/scripts/get-changed-php-files.sh ${{ github.event.pull_request.base.sha }}

      - name: Run PHP-CS-Fixer on changed files
        if: steps.changed-php-files.outputs.has_changes == 'true'
        run: |
          echo "Running PHP-CS-Fixer with parallel processing..."
          ./bin/tools/php-cs-fixer fix --dry-run --diff --format=checkstyle --config=.php-cs-fixer.dist.php ${{ steps.changed-php-files.outputs.files }} | cs2pr

      - name: Run PHP-CS-Fixer (no changes)
        if: steps.changed-php-files.outputs.has_changes == 'false'
        run: echo "✅ No PHP files to check"

  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pour l'analyse différentielle
      
      - name: Prepare environment
        uses: ./.github/actions/prepare-for-quality
      
      - name: Cache PHPStan result cache
        uses: actions/cache@v4
        with:
          path: ./.phpstan-tmp
          key: ${{ runner.os }}-phpstan-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-phpstan-
            ${{ runner.os }}-

      # - name: Install PHPStan
      #   run: |
      #     mkdir -p bin/tools
      #     curl -L https://github.com/phpstan/phpstan/releases/latest/download/phpstan.phar -o bin/tools/phpstan
      #     chmod +x bin/tools/phpstan

      # Pour les PR : analyse seulement les fichiers modifiés
      - name: Get changed PHP files for PHPStan
        id: changed-php-files
        run: ./.github/scripts/get-changed-php-files.sh ${{ github.event.pull_request.base.sha }}
      
      # - name: Run PHPStan on changed files
      #   if: github.event_name == 'pull_request' && steps.changed-php-files.outputs.has_changes == 'true'
      #   run: |
      #     echo "Running PHPStan on changed files with parallel processing..."
      #     make phpstan-files FILES="${{ steps.changed-php-files.outputs.files }}"
      
      - name: Skip PHPStan (no changes)
        if: steps.changed-php-files.outputs.has_changes == 'false'
        run: echo "✅ No relevant PHP files to analyze"

      - name: Run PHPStan (full analysis)
        if: steps.changed-php-files.outputs.has_changes == 'true'
        run: ./bin/tools/phpstan -vvv analyse legacy public src tests -c phpstan.neon -l 1
      