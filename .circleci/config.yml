version: 2
jobs:
  build:
    docker:
      - image: circleci/php:5.6
      # - image: circleci/mysql:5.7-ram

    steps:
      - checkout

      - run: sudo apt-get -yq update
      - run: sudo apt-get install ncftp

      - run:
          name: Deploy the codebase on the server
          command: |
            case ${CIRCLE_BRANCH} in
                "production" )
                    rm -rf .git
                    sed -i "s/ADMIN_PASSWORD_TO_REPLACE/$PROD_ADMIN_PASSWORD/g" "config/www.clubalpinlyon.fr/params.php"
                    sed -i "s/MAILCHIMP_PASSWORD_TO_REPLACE/$MAILCHIMP_PASSWORD/g" "config/www.clubalpinlyon.fr/params.php"
                    sed -i "s/DB_PASSWORD_TO_REPLACE/$PROD_DB_PASSWORD/g" "config/www.clubalpinlyon.fr/db_config.php"
                    sed -i "s/DB_USER_TO_REPLACE/$PROD_DB_USER/g" "config/www.clubalpinlyon.fr/db_config.php"
                    sed -i "s/DB_NAME_TO_REPLACE/$PROD_DB_NAME/g" "config/www.clubalpinlyon.fr/db_config.php"
                    ncftpput -R -v -u $PROD_FTP_USERNAME -p $PROD_FTP_PASSWORD $FTP_SERVER . .
                  ;;
                "main" )
                    rm -rf .git
                    sed -i "s/ADMIN_PASSWORD_TO_REPLACE/$DEV_ADMIN_PASSWORD/g" "config/test.clubalpinlyon.fr/params.php"
                    sed -i "s/MAILCHIMP_PASSWORD_TO_REPLACE/$MAILCHIMP_PASSWORD/g" "config/test.clubalpinlyon.fr/params.php"
                    sed -i "s/DB_PASSWORD_TO_REPLACE/$DEV_DB_PASSWORD/g" "config/test.clubalpinlyon.fr/db_config.php"
                    sed -i "s/DB_USER_TO_REPLACE/$DEV_DB_USER/g" "config/test.clubalpinlyon.fr/db_config.php"
                    sed -i "s/DB_NAME_TO_REPLACE/$DEV_DB_NAME/g" "config/test.clubalpinlyon.fr/db_config.php"
                    ncftpput -R -v -u $DEV_FTP_USERNAME -p $DEV_FTP_PASSWORD $FTP_SERVER . .
                  ;;
            esac